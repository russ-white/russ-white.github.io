import{Primitive as e,bounds as t,PropertyType as n,BufferUtils as o,Root as r,Texture as s,ExtensionProperty as i,ImageUtils as a,MathUtils as c,Node as l,AnimationChannel as g,Scene as u,TextureInfo as f,Accessor as p,AnimationSampler as m,Material as d,TextureChannel as h,uuid as A,PrimitiveTarget as y}from"@gltf-transform/core";export{bounds}from"@gltf-transform/core";import{getPixels as E,savePixels as T}from"ndarray-pixels";import{MeshQuantization as S,DracoMeshCompression as I,MeshGPUInstancing as b,MeshoptCompression as w,MaterialsIOR as N,MaterialsSpecular as M,MaterialsPBRSpecularGlossiness as O,TextureWebP as R,MaterialsUnlit as C}from"@gltf-transform/extensions";import{read as P,KHR_DF_MODEL_ETC1S as x,KHR_DF_MODEL_UASTC as z}from"ktx-parse";import{invert as $,fromRotationTranslationScale as v,fromScaling as L,multiply as _}from"gl-matrix/mat4";import{transformMat4 as G,min as q,scale as k,max as F,normalize as B,create as U,transformMat3 as W}from"gl-matrix/vec3";import{slerp as H,getAngle as j}from"gl-matrix/quat";import D from"ndarray";import{lanczos3 as V,lanczos2 as X}from"ndarray-lanczos";import{create as J,fromMat4 as K,invert as Z,transpose as Q}from"gl-matrix/mat3";import{create as Y}from"gl-matrix/vec4";function ee(){return(ee=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e}).apply(this,arguments)}function te(e,t){return Object.defineProperty(t,"name",{value:e}),t}function ne(e,t,n){return!!e&&e.stack.lastIndexOf(t)<e.stack.lastIndexOf(n)}async function oe(e,t,n){if(!e)return null;const o=e.getImage();if(!o)return null;const r=await E(o,e.getMimeType());for(let e=0;e<r.shape[0];++e)for(let t=0;t<r.shape[1];++t)n(r,e,t);const s=await T(r,"image/png");return t.setImage(s).setMimeType("image/png")}class re{constructor(){this._map=new Map}get size(){return this._map.size}has(e){return this._map.has(e)}add(e,t){let n=this._map.get(e);return n||(n=new Set,this._map.set(e,n)),n.add(t),this}get(e){return this._map.get(e)||new Set}keys(){return this._map.keys()}}function se(e,t=2){if(0===e)return"0 Bytes";const n=t<0?0:t,o=Math.floor(Math.log(e)/Math.log(1e3));return parseFloat((e/Math.pow(1e3,o)).toFixed(n))+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][o]}function ie(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function ae(e,t){return`${ie(e)} → ${ie(t)} (${function(e,t,n=2){return(e>t?"–":"+")+(Math.abs(e-t)/e*100).toFixed(n)+"%"}(e,t)})`}function ce(e){const t=[];for(const n of e.listAttributes())t.push(n);for(const n of e.listTargets())for(const e of n.listAttributes())t.push(e);return Array.from(new Set(t))}function le(e,t,n){e.swap(t,n);for(const o of e.listTargets())o.swap(t,n)}function ge(e,t,n){const o=e.getElementSize(),r=e.getCount(),s=e.getArray(),i=s.slice(0,n*o);for(let e=0;e<r;e++)for(let n=0;n<o;n++)i[t[e]*o+n]=s[e*o+n];e.setArray(i)}function ue(e,t=e){const n=t<=65534?new Uint16Array(e):new Uint32Array(e);for(let e=0;e<n.length;e++)n[e]=e;return n}const fe={pivot:"center"};function pe(e=fe){const n=ee({},fe,e);return te("center",e=>{const o=e.getLogger(),r=e.getRoot(),s=r.listAnimations().length>0||r.listSkins().length>0;e.getRoot().listScenes().forEach((i,a)=>{let c;if(o.debug(`center: Scene ${a+1} / ${r.listScenes().length}.`),"string"==typeof n.pivot){const e=t(i);c=[(e.max[0]-e.min[0])/2+e.min[0],(e.max[1]-e.min[1])/2+e.min[1],(e.max[2]-e.min[2])/2+e.min[2]],"above"===n.pivot&&(c[1]=e.max[1]),"below"===n.pivot&&(c[1]=e.min[1])}else c=n.pivot;o.debug(`center: Pivot "${c.join(", ")}".`);const l=[-1*c[0],-1*c[1],-1*c[2]];if(s){o.debug("center: Model contains animation or skin. Adding a wrapper node.");const t=e.createNode("Pivot").setTranslation(l);i.listChildren().forEach(e=>t.addChild(e)),i.addChild(t)}else o.debug("center: Skipping wrapper, offsetting all root nodes."),i.listChildren().forEach(e=>{const t=e.getTranslation();e.setTranslation([t[0]+l[0],t[1]+l[1],t[2]+l[2]])})}),o.debug("center: Complete.")})}const me="colorspace";function de(e){return te(me,t=>{const n=t.getLogger();if("linear"===e.inputEncoding)return void n.info(`${me}: Vertex colors already linear. Skipping conversion.`);if("sRGB"!==e.inputEncoding)return void n.error(`${me}: Unknown input encoding "${e.inputEncoding}" – should be "sRGB" or "linear". Skipping conversion.`);const o=new Set;function r(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function s(e){const t=[0,0,0];let n;for(let s=0;n=e.getAttribute(`COLOR_${s}`);s++)if(!o.has(n)){for(let e=0;e<n.getCount();e++)n.getElement(e,t),t[0]=r(t[0]),t[1]=r(t[1]),t[2]=r(t[2]),n.setElement(e,t);o.add(n)}}t.getRoot().listMeshes().forEach(e=>e.listPrimitives().forEach(s)),n.debug(`${me}: Complete.`)})}const he={propertyTypes:[n.ACCESSOR,n.MESH,n.TEXTURE,n.MATERIAL]},Ae=function(e=he){const t=ee({},he,e),s=new Set(t.propertyTypes);for(const e of t.propertyTypes)if(!he.propertyTypes.includes(e))throw new Error(`dedup: Unsupported deduplication on type "${e}".`);return te("dedup",e=>{const t=e.getLogger();s.has(n.ACCESSOR)&&function(e,t){const n=new Set,r=new Set,s=new Set,i=new Set,a=t.getRoot().listMeshes();a.forEach(e=>{e.listPrimitives().forEach(e=>{e.listAttributes().forEach(e=>r.add(e));const t=e.getIndices();t&&n.add(t)})});for(const e of t.getRoot().listAnimations())for(const t of e.listSamplers()){const e=t.getInput(),n=t.getOutput();e&&s.add(e),n&&i.add(n)}function c(e){const t=new Map;for(let n=0;n<e.length;n++){const r=e[n],s=o.toView(r.getArray());if(!t.has(r))for(let n=0;n<e.length;n++){const i=e[n];r!==i&&(t.has(i)||r.getType()===i.getType()&&r.getComponentType()===i.getComponentType()&&r.getCount()===i.getCount()&&r.getNormalized()===i.getNormalized()&&o.equals(s,o.toView(i.getArray()))&&t.set(i,r))}}return t}const l=c(Array.from(n));e.debug(`dedup: Found ${l.size} duplicates among ${n.size} indices.`);const g=c(Array.from(r));e.debug(`dedup: Found ${g.size} duplicates among ${r.size} attributes.`);const u=c(Array.from(s)),f=c(Array.from(i));e.debug(`dedup: Found ${u.size+f.size} duplicates among ${s.size+i.size} animation accessors.`),a.forEach(e=>{e.listPrimitives().forEach(e=>{e.listAttributes().forEach(t=>{g.has(t)&&e.swap(t,g.get(t))});const t=e.getIndices();t&&l.has(t)&&e.swap(t,l.get(t))})}),Array.from(l.keys()).forEach(e=>e.dispose()),Array.from(g.keys()).forEach(e=>e.dispose());for(const e of t.getRoot().listAnimations())for(const t of e.listSamplers()){const e=t.getInput(),n=t.getOutput();e&&u.has(e)&&t.swap(e,u.get(e)),n&&f.has(n)&&t.swap(n,f.get(n))}Array.from(u.keys()).forEach(e=>e.dispose()),Array.from(f.keys()).forEach(e=>e.dispose())}(t,e),s.has(n.TEXTURE)&&function(e,t){const n=t.getRoot(),s=n.listTextures(),i=new Map;for(let e=0;e<s.length;e++){const t=s[e],n=t.getImage();if(!i.has(t))for(let e=0;e<s.length;e++){const r=s[e],a=r.getImage();if(t===r)continue;if(i.has(r))continue;if(t.getMimeType()!==r.getMimeType())continue;const c=t.getSize(),l=r.getSize();c&&l&&c[0]===l[0]&&c[1]===l[1]&&n&&a&&o.equals(n,a)&&i.set(r,t)}}e.debug(`dedup: Found ${i.size} duplicates among ${n.listTextures().length} textures.`),Array.from(i.entries()).forEach(([e,t])=>{e.listParents().forEach(n=>{n instanceof r||n.swap(e,t)}),e.dispose()})}(t,e),s.has(n.MATERIAL)&&function(e,t){const n=t.getRoot(),o=n.listMaterials(),s=new Map,i=new Set(["name"]);for(let e=0;e<o.length;e++){const t=o[e];if(!s.has(t))for(let e=0;e<o.length;e++){const n=o[e];t!==n&&(s.has(n)||t.equals(n,i)&&s.set(n,t))}}e.debug(`dedup: Found ${s.size} duplicates among ${n.listMaterials().length} materials.`),Array.from(s.entries()).forEach(([e,t])=>{e.listParents().forEach(n=>{n instanceof r||n.swap(e,t)}),e.dispose()})}(t,e),s.has(n.MESH)&&function(e,t){const o=t.getRoot(),r=new Map;o.listAccessors().forEach((e,t)=>r.set(e,t)),o.listMaterials().forEach((e,t)=>r.set(e,t));const s=o.listMeshes().length,i=new Map;for(const e of o.listMeshes()){const t=[];for(const n of e.listPrimitives())t.push(ye(n,r));const o=t.join(";");if(i.has(o)){const t=i.get(o);e.listParents().forEach(o=>{o.propertyType!==n.ROOT&&o.swap(e,t)}),e.dispose()}else i.set(o,e)}e.debug(`dedup: Found ${s-i.size} duplicates among ${s} meshes.`)}(t,e),t.debug("dedup: Complete.")})};function ye(t,n){const o=[];for(const e of t.listSemantics()){const r=t.getAttribute(e);o.push(e+":"+n.get(r))}if(t instanceof e){const e=t.getIndices();e&&o.push("indices:"+n.get(e));const r=t.getMaterial();r&&o.push("material:"+n.get(r)),o.push("mode:"+t.getMode());for(const e of t.listTargets())o.push("target:"+ye(e,n))}return o.join(",")}const Ee={pattern:/^((?!JOINTS_).)*$/};function Te(e=Ee){const t=ee({},Ee,e);return te("dequantize",e=>{const n=e.getLogger();for(const n of e.getRoot().listMeshes())for(const e of n.listPrimitives())Se(e,t);e.createExtension(S).dispose(),n.debug("dequantize: Complete.")})}function Se(e,t){for(const n of e.listSemantics())Ie(n,e.getAttribute(n),t);for(const n of e.listTargets())for(const e of n.listSemantics())Ie(e,n.getAttribute(e),t)}function Ie(e,t,n){if(!t.getArray())return;if(!n.pattern.test(e))return;if(t.getComponentSize()>=4)return;const o=t.getArray(),r=new Float32Array(o.length);for(let e=0,n=t.getCount(),s=[];e<n;e++)s=t.getElement(e,s),t.setArray(r).setElement(e,s).setArray(o);t.setArray(r).setNormalized(!1)}const be={method:"edgebreaker",encodeSpeed:5,decodeSpeed:5,quantizePosition:14,quantizeNormal:10,quantizeColor:8,quantizeTexcoord:12,quantizeGeneric:12,quantizationVolume:"mesh"},we=e=>{const t=ee({},be,e);return e=>{e.createExtension(I).setRequired(!0).setEncoderOptions({method:"edgebreaker"===t.method?I.EncoderMethod.EDGEBREAKER:I.EncoderMethod.SEQUENTIAL,encodeSpeed:t.encodeSpeed,decodeSpeed:t.decodeSpeed,quantizationBits:{POSITION:t.quantizePosition,NORMAL:t.quantizeNormal,COLOR:t.quantizeColor,TEX_COORD:t.quantizeTexcoord,GENERIC:t.quantizeGeneric},quantizationVolume:t.quantizationVolume})}};function Ne(e){return{scenes:Me(e),meshes:Oe(e),materials:Re(e),textures:Ce(e),animations:Pe(e)}}function Me(e){return{properties:e.getRoot().listScenes().map(e=>{const n=e.listChildren()[0],o=t(e);return{name:e.getName(),rootName:n?n.getName():"",bboxMin:$e(o.min),bboxMax:$e(o.max)}})}}function Oe(t){return{properties:t.getRoot().listMeshes().map(t=>{const o=t.listParents().filter(e=>e.propertyType!==n.ROOT).length;let r=0,s=0;const i=new Set,a=new Set,c=new Set;t.listPrimitives().forEach(t=>{for(const e of t.listSemantics()){const n=t.getAttribute(e);i.add(e+":"+ve(n)),c.add(n)}for(const e of t.listTargets())e.listAttributes().forEach(e=>c.add(e));const n=t.getIndices();n&&(a.add(ve(n)),c.add(n)),s+=t.listAttributes()[0].getCount(),r+=function(t){const n=t.getIndices(),o=t.getAttribute("POSITION");switch(t.getMode()){case e.Mode.POINTS:return o.getCount();case e.Mode.LINES:return n?n.getCount()/2:o.getCount()/2;case e.Mode.LINE_LOOP:return o.getCount();case e.Mode.LINE_STRIP:return o.getCount()-1;case e.Mode.TRIANGLES:return n?n.getCount()/3:o.getCount()/3;case e.Mode.TRIANGLE_STRIP:case e.Mode.TRIANGLE_FAN:return o.getCount()-2;default:throw new Error("Unexpected mode: "+t.getMode())}}(t)});let l=0;Array.from(c).forEach(e=>l+=e.getArray().byteLength);const g=t.listPrimitives().map(e=>xe[e.getMode()]);return{name:t.getName(),mode:Array.from(new Set(g)),primitives:t.listPrimitives().length,glPrimitives:r,vertices:s,indices:Array.from(a).sort(),attributes:Array.from(i).sort(),instances:o,size:l}})}}function Re(e){return{properties:e.getRoot().listMaterials().map(t=>{const o=t.listParents().filter(e=>e.propertyType!==n.ROOT).length,r=new Set(t.listExtensions()),a=e.getGraph().listEdges().filter(e=>{const n=e.getChild(),o=e.getParent();return n instanceof s&&o===t||!!(n instanceof s&&o instanceof i&&r.has(o))}).map(e=>e.getName());return{name:t.getName(),instances:o,textures:a,alphaMode:t.getAlphaMode(),doubleSided:t.getDoubleSided()}})}}function Ce(e){return{properties:e.getRoot().listTextures().map(t=>{const o=t.listParents().filter(e=>e.propertyType!==n.ROOT).length,r=e.getGraph().listParentEdges(t).filter(e=>e.getParent().propertyType!==n.ROOT).map(e=>e.getName()),s=a.getSize(t.getImage(),t.getMimeType());let i="";if("image/ktx2"===t.getMimeType()){const e=P(t.getImage()).dataFormatDescriptor[0];e.colorModel===x?i="ETC1S":e.colorModel===z&&(i="UASTC")}return{name:t.getName(),uri:t.getURI(),slots:Array.from(new Set(r)),instances:o,mimeType:t.getMimeType(),compression:i,resolution:s?s.join("x"):"",size:t.getImage().byteLength,gpuSize:a.getMemSize(t.getImage(),t.getMimeType())}})}}function Pe(e){return{properties:e.getRoot().listAnimations().map(e=>{let t=Infinity,n=-Infinity;e.listSamplers().forEach(e=>{const o=e.getInput();o&&(t=Math.min(t,o.getMin([])[0]),n=Math.max(n,o.getMax([])[0]))});let o=0,r=0;const s=new Set;return e.listSamplers().forEach(e=>{const t=e.getInput(),n=e.getOutput();t&&(r+=t.getCount(),s.add(t),n&&s.add(n))}),Array.from(s).forEach(e=>{o+=e.getArray().byteLength}),{name:e.getName(),channels:e.listChannels().length,samplers:e.listSamplers().length,duration:Math.round(1e3*(n-t))/1e3,keyframes:r,size:o}})}}const xe=["POINTS","LINES","LINE_LOOP","LINE_STRIP","TRIANGLES","TRIANGLE_STRIP","TRIANGLE_FAN"],ze={Float32Array:"f32",Uint32Array:"u32",Uint16Array:"u16",Uint8Array:"u8",Int32Array:"i32",Int16Array:"i16",Int8Array:"i8"};function $e(e){for(let t=0;t<e.length;t++)e[t].toFixed&&(e[t]=Number(e[t].toFixed(5)));return e}function ve(e){const t=e.getArray();return(ze[t.constructor.name]||"?")+(e.getNormalized()?"_norm":"")}const Le={};function _e(e=Le){return ee({},Le,e),te("instance",e=>{const t=e.getLogger(),n=e.getRoot(),o=e.createExtension(b);if(n.listAnimations().length)return t.warn("instance: Instancing is not currently supported for animated models."),void t.debug("instance: Complete.");let r=0,s=0;for(const i of n.listScenes()){const n=new Map;i.traverse(e=>{const t=e.getMesh();t&&n.set(t,(n.get(t)||new Set).add(e))});const a=[];for(const l of Array.from(n.keys())){const g=Array.from(n.get(l));if(g.length<2)continue;if(g.some(e=>e.getSkin()))continue;const u=qe(e,o,l,g.length),f=u.getAttribute("TRANSLATION"),p=u.getAttribute("ROTATION"),m=u.getAttribute("SCALE"),d=e.createNode().setMesh(l).setExtension("EXT_mesh_gpu_instancing",u);i.addChild(d);let h=!1,A=!1,y=!1;for(let e=0;e<g.length;e++){let t,n,o;const r=g[e];f.setElement(e,t=r.getWorldTranslation()),p.setElement(e,n=r.getWorldRotation()),m.setElement(e,o=r.getWorldScale()),c.eq(t,[0,0,0])||(h=!0),c.eq(n,[0,0,0,1])||(A=!0),c.eq(o,[1,1,1])||(y=!0),r.setMesh(null),a.push(r)}h||f.dispose(),A||p.dispose(),y||m.dispose(),Ge(a,t),r++,s+=g.length}}t.info(r>0?`instance: Created ${r} batches, with ${s} total instances.`:"instance: No meshes with multiple parent nodes were found."),0===o.listProperties().length&&o.dispose(),t.debug("instance: Complete.")})}function Ge(e,t){let n,o=0;for(;n=e.pop();){if(n.listChildren().length||n.getCamera()||n.getMesh()||n.getSkin()||n.listExtensions().length)continue;const t=n.getParent();t instanceof l&&e.push(t),n.dispose(),o++}t.debug(`instance: Removed ${o} unused nodes.`)}function qe(e,t,n,o){const r=n.listPrimitives()[0].getAttribute("POSITION").getBuffer(),s=e.createAccessor().setType("VEC3").setArray(new Float32Array(3*o)).setBuffer(r),i=e.createAccessor().setType("VEC4").setArray(new Float32Array(4*o)).setBuffer(r),a=e.createAccessor().setType("VEC3").setArray(new Float32Array(3*o)).setBuffer(r);return t.createInstancedMesh().setAttribute("TRANSLATION",s).setAttribute("ROTATION",i).setAttribute("SCALE",a)}const ke={propertyTypes:[n.NODE,n.SKIN,n.MESH,n.CAMERA,n.PRIMITIVE,n.PRIMITIVE_TARGET,n.ANIMATION,n.MATERIAL,n.TEXTURE,n.ACCESSOR,n.BUFFER],keepLeaves:!1,keepAttributes:!0},Fe=function(e=ke){const t=ee({},ke,e),o=new Set(t.propertyTypes);return te("prune",e=>{const s=e.getLogger(),i=e.getRoot(),a=e.getGraph(),c={};if(o.has(n.NODE)&&!t.keepLeaves&&i.listScenes().forEach(function e(t){if(t.listChildren().forEach(e),t instanceof u)return;const o=a.listParentEdges(t).some(e=>{const t=e.getParent().propertyType;return t!==n.ROOT&&t!==n.SCENE&&t!==n.NODE});0!==a.listChildren(t).length||o||(t.dispose(),m(t))}),o.has(n.NODE)&&i.listNodes().forEach(l),o.has(n.SKIN)&&i.listSkins().forEach(l),o.has(n.MESH)&&i.listMeshes().forEach(l),o.has(n.CAMERA)&&i.listCameras().forEach(l),o.has(n.PRIMITIVE)&&f(a,n.PRIMITIVE),o.has(n.PRIMITIVE_TARGET)&&f(a,n.PRIMITIVE_TARGET),!t.keepAttributes&&o.has(n.ACCESSOR))for(const t of i.listMeshes())for(const n of t.listPrimitives()){const t=Ue(e,n.getMaterial()),o=Be(n,t);p(n,o),n.listTargets().forEach(e=>p(e,o))}if(o.has(n.ANIMATION))for(const e of i.listAnimations()){for(const t of e.listChannels())t.getTargetNode()||(t.dispose(),m(t));if(e.listChannels().length)e.listSamplers().forEach(l);else{const t=e.listSamplers();l(e),t.forEach(l)}}if(o.has(n.MATERIAL)&&i.listMaterials().forEach(l),o.has(n.TEXTURE)&&i.listTextures().forEach(l),o.has(n.ACCESSOR)&&i.listAccessors().forEach(l),o.has(n.BUFFER)&&i.listBuffers().forEach(l),Object.keys(c).length){const e=Object.keys(c).map(e=>`${e} (${c[e]})`).join(", ");s.info(`prune: Removed types... ${e}`)}else s.info("prune: No unused properties found.");function l(e){e.listParents().filter(e=>!(e instanceof r||e instanceof g)).length||(e.dispose(),m(e))}function f(e,t){e.listEdges().map(e=>e.getParent()).filter(e=>e.propertyType===t).forEach(l)}function p(e,t){for(const n of t)e.setAttribute(n,null)}function m(e){c[e.propertyType]=c[e.propertyType]||0,c[e.propertyType]++}s.debug("prune: Complete.")})};function Be(e,t){const n=[];for(const o of e.listSemantics())"TANGENT"!==o||t.has(o)?(o.startsWith("TEXCOORD_")&&!t.has(o)||o.startsWith("COLOR_")&&"COLOR_0"!==o)&&n.push(o):n.push(o);return n}function Ue(e,t,n=new Set){if(!t)return n;const o=e.getGraph().listChildEdges(t),r=new Set;for(const e of o)e.getChild()instanceof s&&r.add(e.getName());for(const t of o){const o=t.getName(),a=t.getChild();a instanceof f&&r.has(o.replace(/Info$/,""))&&n.add(`TEXCOORD_${a.getTexCoord()}`),a instanceof s&&o.match(/normalTexture/i)&&n.add("TANGENT"),a instanceof i&&Ue(e,a,n)}return n}const We={target:"size"};function He(t){const o=ee({},We,t),r=o.encoder;if(!r)throw new Error('reorder: encoder dependency required — install "meshoptimizer".');return te("reorder",async t=>{const s=t.getLogger();await r.ready;const i=je(t);for(const t of i.indicesToAttributes.keys()){const n=t.clone();let s=n.getArray().slice();s instanceof Uint32Array||(s=new Uint32Array(s));const[a,c]=r.reorderMesh(s,i.indicesToMode.get(t)===e.Mode.TRIANGLES,"size"===o.target);n.setArray(c<=65534?new Uint16Array(s):s);for(const e of i.indicesToAttributes.get(t)){const o=e.clone();ge(o,a,c);for(const r of i.attributesToPrimitives.get(e))if(r.getIndices()===t&&r.swap(t,n),r.getIndices()===n){r.swap(e,o);for(const t of r.listTargets())t.swap(e,o)}}}await t.transform(Fe({propertyTypes:[n.ACCESSOR]})),i.indicesToAttributes.size?s.debug("reorder: Complete."):s.warn("reorder: No qualifying primitives found; may need to weld first.")})}function je(e){const t=new re,n=new Map,o=new re;for(const r of e.getRoot().listMeshes())for(const e of r.listPrimitives()){const r=e.getIndices();if(r){n.set(r,e.getMode());for(const n of ce(e))t.add(r,n),o.add(n,e)}}return{indicesToAttributes:t,indicesToMode:n,attributesToPrimitives:o}}function De(e,t=Infinity){if(Number.isFinite(t)&&t%4||t<=0)throw new Error("Limit must be positive multiple of four.");const n=e.getAttribute("POSITION").getCount(),o=e.listSemantics().filter(e=>e.startsWith("WEIGHTS_")).length,r=new Uint16Array(4*o),s=new Float32Array(4*o),i=new Float32Array(4*o),a=new Uint32Array(4*o),l=new Uint32Array(4*o);for(let t=0;t<n;t++){Ve(e,t,"WEIGHTS",s),Ve(e,t,"JOINTS",a);for(let e=0;e<4*o;e++)r[e]=e;r.sort((e,t)=>s[e]>s[t]?-1:1);for(let e=0;e<r.length;e++)i[e]=s[r[e]],l[e]=a[r[e]];Xe(e,t,"WEIGHTS",i),Xe(e,t,"JOINTS",l)}for(let n=o;4*n>t;n--){const t=e.getAttribute("WEIGHTS_"+(n-1)),o=e.getAttribute("JOINTS_"+(n-1));e.setAttribute("WEIGHTS_"+(n-1),null),e.setAttribute("JOINTS_"+(n-1),null),1===t.listParents().length&&t.dispose(),1===o.listParents().length&&o.dispose()}!function(e){if(!function(e){const t=e.listSemantics().filter(e=>e.startsWith("WEIGHTS_")).map(t=>e.getAttribute(t)),n=t.map(e=>e.getNormalized()),o=t.map(e=>e.getComponentType());return 1===new Set(n).size&&1===new Set(o).size}(e))return;const t=e.getAttribute("POSITION").getCount(),n=e.listSemantics().filter(e=>e.startsWith("WEIGHTS_")).length,o=e.getAttribute("WEIGHTS_0"),r=o.getArray(),s=o.getComponentType(),i=o.getNormalized(),a=i?s:void 0,l=i?c.denormalize(1,s):Number.EPSILON,g=new Uint32Array(4*n).fill(0),u=r.slice(0,4*n).fill(0);for(let n=0;n<t;n++){Ve(e,n,"JOINTS",g),Ve(e,n,"WEIGHTS",u,a);let t=Je(u,a);if(0!==t){if(Math.abs(1-t)>l)for(let e=0;e<u.length;e++)if(i){const n=c.normalize(u[e]/t,s);u[e]=c.denormalize(n,s)}else u[e]/=t;if(t=Je(u,a),i&&1!==t)for(let e=u.length-1;e>=0;e--)if(u[e]>0){u[e]+=c.normalize(1-t,s);break}for(let e=u.length-1;e>=0;e--)0===u[e]&&(g[e]=0);Xe(e,n,"JOINTS",g),Xe(e,n,"WEIGHTS",u,a)}}}(e)}function Ve(e,t,n,o,r){let s;const i=[0,0,0,0];for(let a=0;s=e.getAttribute(`${n}_${a}`);a++){s.getElement(t,i);for(let e=0;e<4;e++)o[4*a+e]=r?c.normalize(i[e],r):i[e]}return o}function Xe(e,t,n,o,r){let s;const i=[0,0,0,0];for(let a=0;s=e.getAttribute(`${n}_${a}`);a++){for(let e=0;e<4;e++)i[e]=r?c.denormalize(o[4*a+e],r):o[4*a+e];s.setElement(t,i)}}function Je(e,t){let n=0;for(let o=0;o<e.length;o++)n+=t?c.denormalize(e[o],t):e[o];return n}const Ke=[Int8Array,Int16Array,Int32Array],{TRANSLATION:Ze,ROTATION:Qe,SCALE:Ye,WEIGHTS:et}=g.TargetPath,tt=[Ze,Qe,Ye],nt={pattern:/.*/,quantizationVolume:"mesh",quantizePosition:14,quantizeNormal:10,quantizeTexcoord:12,quantizeColor:8,quantizeWeight:8,quantizeGeneric:12,normalizeWeights:!0},ot=(e=nt)=>{const t=ee({},nt,e);return te("quantize",async e=>{const o=e.getLogger(),r=e.getRoot();let s;e.createExtension(S).setRequired(!0),"scene"===t.quantizationVolume&&(s=st(function(e){const t=e[0];for(const n of e)q(t.min,t.min,n.min),F(t.max,t.max,n.max);return t}(r.listMeshes().map(ut))));for(const n of e.getRoot().listMeshes()){"mesh"===t.quantizationVolume&&(s=st(ut(n))),s&&t.pattern.test("POSITION")&&(it(e,n,s),ct(n,1/s.scale));for(const o of n.listPrimitives()){rt(e,o,s,t);for(const n of o.listTargets())rt(e,n,s,t)}}await e.transform(Fe({propertyTypes:[n.ACCESSOR,n.SKIN,n.MATERIAL]}),Ae({propertyTypes:[n.ACCESSOR,n.MATERIAL]})),o.debug("quantize: Complete.")})};function rt(t,n,o,r){const s=t.getLogger();for(const t of n.listSemantics()){if(!r.pattern.test(t))continue;const i=n.getAttribute(t),{bits:a,ctor:c}=gt(t,i,s,r);if(!c)continue;if(a<8||a>16)throw new Error("quantize: Requires bits = 8–16.");if(i.getComponentSize()<=a/8)continue;const l=i.clone();if("POSITION"===t){const t=o.scale,r=[];n instanceof e?$(r,pt(o)):L(r,[1/t,1/t,1/t]);for(let e=0,t=[0,0,0],n=l.getCount();e<n;e++)l.getElement(e,t),l.setElement(e,G(t,t,r))}lt(l,c,a),n.swap(i,l)}if(r.normalizeWeights&&n.getAttribute("WEIGHTS_0")&&De(n,Infinity),n instanceof e&&n.getIndices()&&n.listAttributes().length&&n.listAttributes()[0].getCount()<65535){const e=n.getIndices();e.setArray(new Uint16Array(e.getArray()))}}function st(e){const{min:t,max:n}=e,o=Math.max((n[0]-t[0])/2,(n[1]-t[1])/2,(n[2]-t[2])/2);return{offset:[t[0]+(n[0]-t[0])/2,t[1]+(n[1]-t[1])/2,t[2]+(n[2]-t[2])/2],scale:o}}function it(e,t,n){const o=pt(n);for(const r of t.listParents()){if(!(r instanceof l))continue;const s=r.listParents().filter(e=>e instanceof g),i=s.some(e=>tt.includes(e.getTargetPath())),a=r.listChildren().length>0;if(r.getSkin()){r.setSkin(at(r.getSkin(),n));continue}let c;a||i?(c=e.createNode("").setMesh(t),r.addChild(c).setMesh(null),s.filter(e=>e.getTargetPath()===et).forEach(e=>e.setTargetNode(c))):c=r;const u=c.getMatrix();_(u,u,o),c.setMatrix(u)}}function at(e,t){e=e.clone();const n=pt(t),o=e.getInverseBindMatrices().clone(),r=[];for(let e=0,t=o.getCount();e<t;e++)o.getElement(e,r),_(r,r,n),o.setElement(e,r);return e.setInverseBindMatrices(o)}function ct(e,t){for(const n of e.listPrimitives()){let e=n.getMaterial();if(!e)continue;let o=e.getExtension("KHR_materials_volume");!o||o.getThicknessFactor()<=0||(o=o.clone().setThicknessFactor(o.getThicknessFactor()*t),e=e.clone().setExtension("KHR_materials_volume",o),n.setMaterial(e))}}function lt(e,t,n){const o=new t(e.getArray().length),r=Ke.includes(t)?1:0,s=n-r,i=8*t.BYTES_PER_ELEMENT-r,a=Math.pow(2,s)-1,c=i-s,l=2*s-i;for(let t=0,n=0,r=[];t<e.getCount();t++){e.getElement(t,r);for(let e=0;e<r.length;e++){let t=Math.round(Math.abs(r[e])*a);t=t<<c|t>>l,o[n++]=t*Math.sign(r[e])}}e.setArray(o).setNormalized(!0)}function gt(e,t,n,o){const r=t.getMinNormalized([]),s=t.getMaxNormalized([]);let i,a;if("POSITION"===e)i=o.quantizePosition,a=i<=8?Int8Array:Int16Array;else if("NORMAL"===e||"TANGENT"===e)i=o.quantizeNormal,a=i<=8?Int8Array:Int16Array;else if(e.startsWith("COLOR_"))i=o.quantizeColor,a=i<=8?Uint8Array:Uint16Array;else if(e.startsWith("TEXCOORD_")){if(r.some(e=>e<0)||s.some(e=>e>1))return n.warn(`quantize: Skipping ${e}; out of [0,1] range.`),{bits:-1};i=o.quantizeTexcoord,a=i<=8?Uint8Array:Uint16Array}else{if(e.startsWith("JOINTS_"))return i=Math.max(...t.getMax([]))<=255?8:16,a=i<=8?Uint8Array:Uint16Array,t.getComponentSize()>i/8&&t.setArray(new a(t.getArray())),{bits:-1};if(e.startsWith("WEIGHTS_")){if(r.some(e=>e<0)||s.some(e=>e>1))return n.warn(`quantize: Skipping ${e}; out of [0,1] range.`),{bits:-1};i=o.quantizeWeight,a=i<=8?Uint8Array:Uint16Array}else{if(!e.startsWith("_"))throw new Error(`quantize: Unexpected semantic, "${e}".`);if(r.some(e=>e<-1)||s.some(e=>e>1))return n.warn(`quantize: Skipping ${e}; out of [-1,1] range.`),{bits:-1};i=o.quantizeGeneric,a=a=r.some(e=>e<0)?i<=8?Int8Array:Int16Array:i<=8?Uint8Array:Uint16Array}}return{bits:i,ctor:a}}function ut(e){const t=[],n=[];for(const o of e.listPrimitives()){const e=o.getAttribute("POSITION");e&&t.push(e);for(const e of o.listTargets()){const t=e.getAttribute("POSITION");t&&n.push(t)}}if(0===t.length)throw new Error('quantize: Missing "POSITION" attribute.');const o=ft(t,3);if(n.length>0){const{min:e,max:t}=ft(n,3);q(o.min,o.min,q(e,k(e,e,2),[0,0,0])),F(o.max,o.max,F(t,k(t,t,2),[0,0,0]))}return o}function ft(e,t){const n=new Array(t).fill(Infinity),o=new Array(t).fill(-Infinity),r=[],s=[];for(const i of e){i.getMinNormalized(r),i.getMaxNormalized(s);for(let e=0;e<t;e++)n[e]=Math.min(n[e],r[e]),o[e]=Math.max(o[e],s[e])}return{min:n,max:o}}function pt(e){return v([],[0,0,0,1],e.offset,[e.scale,e.scale,e.scale])}const mt={level:"high"},dt=e=>{const t=ee({},mt,e),n=t.encoder;if(!n)throw new Error('meshopt: encoder dependency required — install "meshoptimizer".');return async e=>{await e.transform(He({encoder:n,target:"size"}),ot({pattern:"medium"===t.level?/.*/:/^(POSITION|TEXCOORD|JOINTS|WEIGHTS)(_\d+)?$/,quantizePosition:14,quantizeTexcoord:12,quantizeColor:8,quantizeNormal:8})),e.createExtension(w).setRequired(!0).setEncoderOptions({method:"medium"===t.level?w.EncoderMethod.QUANTIZE:w.EncoderMethod.FILTER})}},ht={};function At(e=ht){return ee({},ht,e),te("metalRough",async e=>{const t=e.getLogger();if(!e.getRoot().listExtensionsUsed().map(e=>e.extensionName).includes("KHR_materials_pbrSpecularGlossiness"))return void t.warn("metalRough: KHR_materials_pbrSpecularGlossiness not found on document.");const n=e.createExtension(N),o=e.createExtension(M),r=e.createExtension(O),s=new Set;for(const t of e.getRoot().listMaterials()){const r=t.getExtension("KHR_materials_pbrSpecularGlossiness");if(!r)continue;const i=o.createSpecular().setSpecularFactor(1).setSpecularColorFactor(r.getSpecularFactor());s.add(r.getSpecularGlossinessTexture()),s.add(t.getBaseColorTexture()),s.add(t.getMetallicRoughnessTexture()),t.setBaseColorFactor(r.getDiffuseFactor()).setMetallicFactor(0).setRoughnessFactor(1).setExtension("KHR_materials_ior",n.createIOR().setIOR(1e3)).setExtension("KHR_materials_specular",i);const a=r.getDiffuseTexture();a&&(t.setBaseColorTexture(a),t.getBaseColorTextureInfo().copy(r.getDiffuseTextureInfo()));const c=r.getSpecularGlossinessTexture();if(c){const n=r.getSpecularGlossinessTextureInfo(),o=e.createTexture();await oe(c,o,(e,t,n)=>{e.set(t,n,3,255)}),i.setSpecularTexture(o),i.setSpecularColorTexture(o),i.getSpecularTextureInfo().copy(n),i.getSpecularColorTextureInfo().copy(n);const s=r.getGlossinessFactor(),a=e.createTexture();await oe(c,a,(e,t,n)=>{const o=255-Math.round(e.get(t,n,3)*s);e.set(t,n,0,0),e.set(t,n,1,o),e.set(t,n,2,0),e.set(t,n,3,255)}),t.setMetallicRoughnessTexture(a),t.getMetallicRoughnessTextureInfo().copy(n)}else i.setSpecularColorFactor(r.getSpecularFactor()),t.setRoughnessFactor(1-r.getGlossinessFactor());t.setExtension("KHR_materials_pbrSpecularGlossiness",null)}r.dispose();for(const e of s)e&&1===e.listParents().length&&e.dispose();t.debug("metalRough: Complete.")})}const yt={};function Et(e=yt){return ee({},yt,e),te("unweld",e=>{const t=e.getLogger(),n=new Map;for(const o of e.getRoot().listMeshes())for(const e of o.listPrimitives()){const o=e.getIndices();if(!o)continue;const r=e.getAttribute("POSITION").getCount();for(const r of e.listAttributes())e.swap(r,Tt(r,o,t,n)),1===r.listParents().length&&r.dispose();for(const r of e.listTargets())for(const e of r.listAttributes())r.swap(e,Tt(e,o,t,n)),1===e.listParents().length&&e.dispose();const s=e.getAttribute("POSITION").getCount();t.debug(`unweld: ${ae(r,s)} vertices.`),e.setIndices(null),1===o.listParents().length&&o.dispose()}t.debug("unweld: Complete.")})}function Tt(e,t,n,o){if(o.has(e)&&o.get(e).has(t))return n.debug(`unweld: Cache hit for reused attribute, "${e.getName()}".`),o.get(e).get(t);const r=e.clone(),s=e.getArray().constructor;r.setArray(new s(t.getCount()*e.getElementSize()));const i=[];for(let n=0;n<t.getCount();n++)r.setElement(n,e.getElement(t.getScalar(n),i));return o.has(e)||o.set(e,new Map),o.get(e).set(t,r),r}const St={overwrite:!1};function It(e=St){const t=ee({},St,e);return te("normals",async e=>{const n=e.getLogger();let o=0;await e.transform(Et());for(const r of e.getRoot().listMeshes())for(const s of r.listPrimitives()){const r=s.getAttribute("POSITION");let i=s.getAttribute("NORMAL");if(t.overwrite&&i)i.dispose();else if(i){n.debug("normals: Skipping primitive: NORMAL found.");continue}i=e.createAccessor().setArray(new Float32Array(3*r.getCount())).setType("VEC3");const a=[0,0,0],c=[0,0,0],l=[0,0,0];for(let e=0;e<r.getCount();e+=3){r.getElement(e+0,a),r.getElement(e+1,c),r.getElement(e+2,l);const t=bt(a,c,l);i.setElement(e+0,t),i.setElement(e+1,t),i.setElement(e+2,t)}s.setAttribute("NORMAL",i),o++}o?n.debug("normals: Complete."):n.warn("normals: No qualifying primitives found. See debug output.")})}function bt(e,t,n){const o=[t[0]-e[0],t[1]-e[1],t[2]-e[2]],r=[n[0]-e[0],n[1]-e[1],n[2]-e[2]];return B([0,0,0],[o[1]*r[2]-o[2]*r[1],o[2]*r[0]-o[0]*r[2],o[0]*r[1]-o[1]*r[0]])}const wt={animations:!0,meshes:!0},Nt=(e=wt)=>{const t=ee({},wt,e);return te("partition",async e=>{const o=e.getLogger();!1!==t.meshes&&function(e,t,n){const o=new Set(e.getRoot().listBuffers().map(e=>e.getURI()));e.getRoot().listMeshes().forEach((r,s)=>{if(Array.isArray(n.meshes)&&!n.meshes.includes(r.getName()))return void t.debug(`partition: Skipping mesh #${s} with name "${r.getName()}".`);t.debug(`partition: Creating buffer for mesh "${r.getName()}".`);const i=e.createBuffer(r.getName()).setURI(Mt(r.getName()||"mesh",o));r.listPrimitives().forEach(e=>{const t=e.getIndices();t&&t.setBuffer(i),e.listAttributes().forEach(e=>e.setBuffer(i)),e.listTargets().forEach(e=>{e.listAttributes().forEach(e=>e.setBuffer(i))})})})}(e,o,t),!1!==t.animations&&function(e,t,n){const o=new Set(e.getRoot().listBuffers().map(e=>e.getURI()));e.getRoot().listAnimations().forEach((r,s)=>{if(Array.isArray(n.animations)&&!n.animations.includes(r.getName()))return void t.debug(`partition: Skipping animation #${s} with name "${r.getName()}".`);t.debug(`partition: Creating buffer for animation "${r.getName()}".`);const i=e.createBuffer(r.getName()).setURI(Mt(r.getName()||"animation",o));r.listSamplers().forEach(e=>{const t=e.getInput(),n=e.getOutput();t&&t.setBuffer(i),n&&n.setBuffer(i)})})}(e,o,t),t.meshes||t.animations||o.warn("partition: Select animations or meshes to create a partition."),await e.transform(Fe({propertyTypes:[n.BUFFER]})),o.debug("partition: Complete.")})};function Mt(e,t){let n=`${e}.bin`,o=1;for(;t.has(n);)n=`${e}_${o++}.bin`;return n}const Ot={tolerance:1e-4},Rt=(e=Ot)=>{const t=ee({},Ot,e);return te("resample",async(e,o)=>{const s=new Set,i=e.getRoot().listAccessors().length,a=e.getLogger();let c=!1;for(const n of e.getRoot().listAnimations()){const e=new Map;for(const t of n.listChannels())e.set(t.getSampler(),t.getTargetPath());for(const o of n.listSamplers())"weights"!==e.get(o)?"STEP"!==o.getInterpolation()&&"LINEAR"!==o.getInterpolation()||(s.add(o.getInput()),s.add(o.getOutput()),Ct(o,e.get(o),t)):c=!0}for(const e of Array.from(s.values()))e.listParents().some(e=>!(e instanceof r))||e.dispose();e.getRoot().listAccessors().length>i&&!ne(o,"resample","dedup")&&await e.transform(Ae({propertyTypes:[n.ACCESSOR]})),c&&a.warn("resample: Skipped optimizing morph target keyframes, not yet supported."),a.debug("resample: Complete.")})};function Ct(e,t,n){const o=e.getInput().clone(),r=e.getOutput().clone(),s=n.tolerance,i=e.getInterpolation(),a=o.getCount()-1,l=[],g=[],u=[],f=[];let p=1;for(let e=1;e<a;++e){const n=o.getScalar(p-1),a=o.getScalar(e),m=o.getScalar(e+1),d=(a-n)/(m-n);let h=!1;if(a!==m&&(1!==e||a!==o.getScalar(0)))if(r.getElement(p-1,f),r.getElement(e,g),r.getElement(e+1,u),"LINEAR"===i&&"rotation"===t){const e=H(l,f,u,d),t=j(f,g)+j(g,u);h=!c.eq(g,e,s)||t+Number.EPSILON>=Math.PI}else if("LINEAR"===i){const e=xt(l,f,u,d);h=!c.eq(g,e,s)}else"STEP"===i&&(h=!c.eq(g,f)||!c.eq(g,u));h&&(e!==p&&(o.setScalar(p,o.getScalar(e)),r.setElement(p,r.getElement(e,l))),p++)}a>0&&(o.setScalar(p,o.getScalar(a)),r.setElement(p,r.getElement(a,l)),p++),p!==o.getCount()?(o.setArray(o.getArray().slice(0,p)),r.setArray(r.getArray().slice(0,p*r.getElementSize())),e.setInput(o),e.setOutput(r)):(o.dispose(),r.dispose())}function Pt(e,t,n){return e*(1-n)+t*n}function xt(e,t,n,o){for(let r=0;r<t.length;r++)e[r]=Pt(t[r],n[r],o);return e}const zt={name:"",fps:10,pattern:/.*/,sort:!0};function $t(e=zt){const t=ee({},zt,e);return te("sequence",e=>{const n=e.getLogger(),o=e.getRoot(),r=t.fps,s=o.listNodes().filter(e=>e.getName().match(t.pattern));t.sort&&s.sort((e,t)=>e.getName()>t.getName()?1:-1);const i=e.createAnimation(t.name),a=o.listBuffers()[0];s.forEach((t,n)=>{let o,c;0===n?(o=[n/r,(n+1)/r],c=[1,1,1,0,0,0]):n===s.length-1?(o=[(n-1)/r,n/r],c=[0,0,0,1,1,1]):(o=[(n-1)/r,n/r,(n+1)/r],c=[0,0,0,1,1,1,0,0,0]);const l=e.createAccessor().setArray(new Float32Array(o)).setBuffer(a),u=e.createAccessor().setArray(new Float32Array(c)).setBuffer(a).setType(p.Type.VEC3),f=e.createAnimationSampler().setInterpolation(m.Interpolation.STEP).setInput(l).setOutput(u),d=e.createAnimationChannel().setTargetNode(t).setTargetPath(g.TargetPath.SCALE).setSampler(f);i.addSampler(f).addChannel(d)}),n.debug("sequence: Complete.")})}const vt={tolerance:1e-4,overwrite:!0};function Lt(e=vt){const t=ee({},vt,e);if(t.tolerance>.1||t.tolerance<0)throw new Error("weld: Requires 0 ≤ tolerance ≤ 0.1");return te("weld",async(e,o)=>{const r=e.getLogger();for(const n of e.getRoot().listMeshes())for(const o of n.listPrimitives())_t(e,o,t);ne(o,"weld","dedup")||await e.transform(Ae({propertyTypes:[n.ACCESSOR]})),r.debug("weld: Complete.")})}function _t(t,n,o){n.getIndices()&&!o.overwrite||n.getMode()!==e.Mode.POINTS&&(0===o.tolerance?function(e,t){if(t.getIndices())return;const n=t.listAttributes()[0],o=n.getCount(),r=n.getBuffer(),s=e.createAccessor().setBuffer(r).setType(p.Type.SCALAR).setArray(ue(o));t.setIndices(s)}(t,n):function(e,t,n){const o=e.getLogger(),r=t.getAttribute("POSITION"),s=t.getIndices()||e.createAccessor().setArray(ue(r.getCount())),i=new Uint32Array(new Set(s.getArray())),a=Math.max(n.tolerance,Number.EPSILON),c={};for(const e of t.listSemantics()){const n=t.getAttribute(e);c[e]=Ft(e,n,a)}var l;o.debug(`weld: Tolerance thresholds: ${l=c,Object.entries(l).map(([e,t])=>`${e}=${t}`).join(", ")}`);const g=[0,0,0],u=[0,0,0];i.sort((e,t)=>(r.getElement(e,g),r.getElement(t,u),g[0]>u[0]?1:-1));const f=ue(i.length),p=ue(i.length),m=r.getCount();let d=0,h=0;for(let e=0;e<i.length;e++){const n=i[e];for(let o=e-1;o>=0;o--){const e=f[i[o]];if(r.getElement(n,g),r.getElement(e,u),Math.abs(g[0]-u[0])>c.POSITION)break;h++;const s=t.listSemantics().every(o=>Bt(t.getAttribute(o),n,e,c[o])),a=t.listTargets().every(t=>t.listSemantics().every(o=>Bt(t.getAttribute(o),n,e,c[o])));if(s&&a){f[n]=e;break}}p[n]=f[n]===n?d++:p[f[n]]}o.debug(`weld: Iterations per vertex: ${Math.round(h/i.length)} (avg)`),o.debug(`weld: ${ae(m,d)} vertices.`);const A=s.getCount(),y=ue(A,i.length);for(let e=0;e<A;e++)y[e]=p[s.getScalar(e)];t.setIndices(s.clone().setArray(y)),1===s.listParents().length&&s.dispose();for(const e of t.listAttributes())Gt(t,e,p,d);for(const e of t.listTargets())for(const t of e.listAttributes())Gt(e,t,p,d)}(t,n,o))}function Gt(e,t,n,o){const r=(s=t.getArray(),i=o*t.getElementSize(),new(0,s.constructor)(i));var s,i;const a=t.clone().setArray(r),c=new Uint8Array(o);for(let e=0,o=[];e<n.length;e++)c[n[e]]||(a.setElement(n[e],t.getElement(e,o)),c[n[e]]=1);e.swap(t,a),1===t.listParents().length&&t.dispose()}const qt=[],kt=[];function Ft(e,t,n){return"NORMAL"===e||"TANGENT"===e?.5:e.startsWith("COLOR_")?.01:e.startsWith("TEXCOORD_")?1e-4:e.startsWith("JOINTS_")?0:e.startsWith("WEIGHTS_")?.01:(qt.length=kt.length=0,t.getMinNormalized(qt),t.getMaxNormalized(kt),n*(Math.max(...kt)-Math.min(...qt)||1))}function Bt(e,t,n,o,r){e.getElement(t,qt),e.getElement(n,kt);for(let t=0,n=e.getElementSize();t<n;t++)if(Math.abs(qt[t]-kt[t])>o)return!1;return!0}const Ut={ratio:.5,error:.001,lockBorder:!1},Wt=t=>{const o=ee({},Ut,t),r=o.simplifier;if(!r)throw new Error('simplify: simplifier dependency required — install "meshoptimizer".');return te("simplify",async(t,s)=>{const i=t.getLogger();await r.ready,await t.transform(Lt({overwrite:!1}));for(const n of t.getRoot().listMeshes())for(const r of n.listPrimitives())r.getMode()===e.Mode.TRIANGLES?Ht(t,r,o):i.warn(`simplify: Skipping primitive of mesh "${n.getName()}": Requires TRIANGLES draw mode.`);ne(s,"simplify","dedup")||await t.transform(Ae({propertyTypes:[n.ACCESSOR]})),i.debug("simplify: Complete.")})};function Ht(e,t,n){const o=ee({},Ut,n),r=o.simplifier,s=e.getLogger(),i=t.getAttribute("POSITION"),a=t.getIndices(),c=i.getCount();let l=i.getArray(),g=a.getArray();if(i.getComponentType()!==p.ComponentType.FLOAT)if(i.getNormalized()){const e=l,t=new Float32Array(e.length);for(let n=0,o=i.getCount(),r=[];n<o;n++)r=i.getElement(n,r),i.setArray(t).setElement(n,r).setArray(e);l=t}else l=new Float32Array(l);a.getComponentType()!==p.ComponentType.UNSIGNED_INT&&(g=new Uint32Array(g));const u=3*Math.floor(o.ratio*c/3),[f,m]=r.simplify(g,l,3,u,o.error,o.lockBorder?["LockBorder"]:[]),[d,h]=r.compactMesh(f);s.debug(`simplify: ${ae(i.getCount(),h)} vertices, error: ${m.toFixed(4)}.`);for(const e of ce(t)){const n=e.clone();ge(n,d,h),le(t,e,n),1===e.listParents().length&&e.dispose()}const A=a.clone();return A.setArray(c<=65534?new Uint16Array(f):f),t.setIndices(A),1===a.listParents().length&&a.dispose(),t}function jt(e,t){const n=Dt(e,t),o=[];return n&h.R&&o.push(h.R),n&h.G&&o.push(h.G),n&h.B&&o.push(h.B),n&h.A&&o.push(h.A),o}function Dt(e,t){let o=0;for(const r of e.getGraph().listParentEdges(t)){const t=r.getParent();let{channels:s}=r.getAttributes();s&&"baseColorTexture"===r.getName()&&t instanceof d&&t.getAlphaMode()===d.AlphaMode.OPAQUE&&(s&=~h.A),s?o|=s:t.propertyType!==n.ROOT&&e.getLogger().warn(`Missing attribute ".channels" on edge, "${r.getName()}".`)}return o}function Vt(e,t){const n=e.getRoot(),o=e.getGraph().listParentEdges(t).filter(e=>e.getParent()!==n).map(e=>e.getName());return Array.from(new Set(o))}var Xt;!function(e){e.OXIPNG="oxipng",e.MOZJPEG="mozjpeg",e.WEBP="webp"}(Xt||(Xt={}));const Jt={[Xt.OXIPNG]:"image/png",[Xt.MOZJPEG]:"image/jpeg",[Xt.WEBP]:"image/webp"},Kt={jobs:4,formats:/.*/,slots:/.*/,auto:!1},Zt=ee({},Kt,{codec:Xt.WEBP}),Qt=ee({},Kt,{codec:Xt.MOZJPEG,formats:/^image\/jpeg$/}),Yt=ee({},Kt,{codec:Xt.OXIPNG,formats:/^image\/png$/}),en=["image/jpeg","image/png","image/webp"];let tn=null,nn=0;const on=(e,t)=>(tn||(tn=new e.ImagePool(t)),nn++,tn),rn=()=>{nn--,tn&&nn<=0&&(tn.close(),tn=null)},sn=function(e){const t=ee({},Kt,e),n=t.squoosh,o=t.codec;if(!n)throw new Error(`${o}: squoosh dependency required — install "@squoosh/lib".`);return async e=>{const r=e.getLogger(),s=e.getRoot().listTextures(),i=on(n,t.jobs);await Promise.all(s.map(async(n,s)=>{const a=Vt(e,n),c=Dt(e,n),l=n.getURI()||n.getName()||`${s+1}/${e.getRoot().listTextures().length}`,g=`${o}:texture(${l})`;if(!en.includes(n.getMimeType()))return void r.debug(`${g}: Skipping, unsupported texture type "${n.getMimeType()}".`);if(!t.formats.test(n.getMimeType()))return void r.debug(`${g}: Skipping, "${n.getMimeType()}" excluded by "formats" parameter.`);if(a.length&&!a.some(e=>t.slots.test(e)))return void r.debug(`${g}: Skipping, [${a.join(", ")}] excluded by "slots" parameter.`);if(t.codec===Xt.MOZJPEG&&c&h.A)return void r.warn(`${g}: Skipping, [${a.join(", ")}] requires alpha channel.`);r.debug(`${g}: Slots → [${a.join(", ")}]`);const u=i.ingestImage(n.getImage()),f=n.getImage().byteLength;await u.encode({[t.codec]:t.auto?"auto":{}});const p=await u.encodedWith[t.codec];r.debug(`${g}: ${JSON.stringify(p.optionsUsed)}`),n.setImage(p.binary).setMimeType(Jt[t.codec]);const m=p.binary.byteLength;r.debug(`${g}: ${se(f)} → ${se(m)}`)})),rn(),r.debug(`${o}: Complete.`)}},an=function(e){const t=ee({},Zt,e);return async e=>{await sn(t)(e),e.getRoot().listTextures().some(e=>e.getMimeType()===Jt[Xt.WEBP])&&e.createExtension(R).setRequired(!0)}},cn=function(e){const t=ee({},Qt,e);return e=>sn(t)(e)},ln=function(e){const t=ee({},Yt,e);return e=>sn(t)(e)},gn={overwrite:!1};function un(e=gn){if(!e.generateTangents)throw new Error('tangents: generateTangents callback required — install "mikktspace".');const t=ee({},gn,e);return te("tangents",e=>{const n=e.getLogger(),o=new Map,r=new Map;let s=0;for(const i of e.getRoot().listMeshes()){const a=i.getName(),c=i.listPrimitives();for(let i=0;i<c.length;i++){const l=c[i];if(!pn(l,n,a,i,t.overwrite))continue;const g=fn(l),u=l.getAttribute("POSITION").getArray(),f=l.getAttribute("NORMAL").getArray(),p=l.getAttribute(g).getArray(),m=o.get(u)||A();o.set(u,m);const d=o.get(f)||A();o.set(f,d);const h=o.get(p)||A();o.set(p,h);const y=l.getAttribute("TANGENT");y&&2===y.listParents().length&&y.dispose();const E=`${m}|${d}|${h}`;let T=r.get(E);if(T){n.debug(`tangents: Found cache for primitive ${i} of mesh "${a}".`),l.setAttribute("TANGENT",T),s++;continue}n.debug(`tangents: Generating for primitive ${i} of mesh "${a}".`);const S=l.getAttribute("POSITION").getBuffer(),I=t.generateTangents(u instanceof Float32Array?u:new Float32Array(u),f instanceof Float32Array?f:new Float32Array(f),p instanceof Float32Array?p:new Float32Array(p));for(let e=3;e<I.length;e+=4)I[e]*=-1;T=e.createAccessor().setBuffer(S).setArray(I).setType("VEC4"),l.setAttribute("TANGENT",T),r.set(E,T),s++}}s?n.debug("tangents: Complete."):n.warn("tangents: No qualifying primitives found. See debug output.")})}function fn(e){const t=e.getMaterial();if(!t)return"TEXCOORD_0";const n=t.getNormalTextureInfo();if(!n)return"TEXCOORD_0";const o=`TEXCOORD_${n.getTexCoord()}`;return e.getAttribute(o)?o:"TEXCOORD_0"}function pn(t,n,o,r,s){return t.getMode()===e.Mode.TRIANGLES&&t.getAttribute("POSITION")&&t.getAttribute("NORMAL")&&t.getAttribute("TEXCOORD_0")?t.getAttribute("TANGENT")&&!s?(n.debug(`tangents: Skipping primitive ${r} of mesh "${o}": TANGENT found.`),!1):!t.getIndices()||(n.warn(`tangents: Skipping primitive ${r} of mesh "${o}": primitives must be unwelded.`),!1):(n.debug(`tangents: Skipping primitive ${r} of mesh "${o}": primitives must have attributes=[POSITION, NORMAL, TEXCOORD_0] and mode=TRIANGLES.`),!1)}const mn="textureResize";var dn;!function(e){e.LANCZOS3="lanczos3",e.LANCZOS2="lanczos2"}(dn||(dn={}));const hn={size:[2048,2048],filter:dn.LANCZOS3,pattern:null,slots:null};function An(e=hn){const t=ee({},hn,e);return te(mn,async e=>{const n=e.getLogger();for(const o of e.getRoot().listTextures()){const r=o.getName(),s=o.getURI();if(t.pattern&&!t.pattern.test(r)&&!t.pattern.test(s)){n.debug(`${mn}: Skipping, excluded by "pattern" parameter.`);continue}if("image/png"!==o.getMimeType()&&"image/jpeg"!==o.getMimeType()){n.warn(`${mn}: Skipping, unsupported texture type "${o.getMimeType()}".`);continue}const i=Vt(e,o);if(t.slots&&!i.some(e=>{var n;return null==(n=t.slots)?void 0:n.test(e)})){n.debug(`${mn}: Skipping, [${i.join(", ")}] excluded by "slots" parameter.`);continue}const[a,c]=t.size,[l,g]=o.getSize();if(l<=a&&g<=c){n.debug(`${mn}: Skipping, not within size range.`);continue}let u=l,f=g;u>a&&(f=Math.floor(f*(a/u)),u=a),f>c&&(u=Math.floor(u*(c/f)),f=c);const p=o.getImage(),m=await E(p,o.getMimeType()),d=D(new Uint8Array(u*f*4),[u,f,4]);n.debug(`${mn}: Resizing "${s||r}", ${m.shape} → ${d.shape}...`),n.debug(`${mn}: Slots → [${i.join(", ")}]`);try{t.filter===dn.LANCZOS3?V(m,d):X(m,d)}catch(e){if(e instanceof Error){n.warn(`${mn}: Failed to resize "${s||r}": "${e.message}".`);continue}throw e}o.setImage(await T(d,o.getMimeType()))}n.debug(`${mn}: Complete.`)})}function yn(t,o,r=!1,s){for(const e of t.listPrimitives())if(e.listParents().some(e=>e.propertyType===n.MESH&&e!==t)){const n=e.clone();t.swap(e,n);for(const e of n.listTargets()){const t=e.clone();n.swap(e,t)}}if(!r){const n=new Set([...t.listPrimitives(),...t.listPrimitives().flatMap(e=>e.listTargets())]),o=new Map;for(const r of t.listPrimitives())for(const t of ce(r))t.listParents().some(t=>(t instanceof e||t instanceof y)&&!n.has(t))&&!o.has(t)&&o.set(t,t.clone());for(const e of n)for(const[t,n]of o)e.swap(t,n)}s=s||new Set;for(const e of t.listPrimitives())En(e,o,s)}function En(e,t,n=new Set){var o;const r=e.getAttribute("POSITION"),s=(null==(o=e.getIndices())?void 0:o.getArray())||ue(r.getCount());r&&Tn(t,r,s,new Set(n));const i=e.getAttribute("NORMAL");i&&Sn(t,i,s,new Set(n));const a=e.getAttribute("TANGENT");a&&In(t,a,s,new Set(n));for(const o of e.listTargets()){const e=o.getAttribute("POSITION");e&&Tn(t,e,s,new Set(n));const r=o.getAttribute("NORMAL");r&&Sn(t,r,s,new Set(n));const i=o.getAttribute("TANGENT");i&&In(t,i,s,new Set(n))}for(let e=0;e<s.length;e++)n.add(s[e])}function Tn(e,t,n,o){const r=new Float32Array(3*t.getCount()),s=t.getElementSize();for(let e=0,n=[],o=t.getCount();e<o;e++)r.set(t.getElement(e,n),e*s);const i=U();for(let s=0;s<n.length;s++){const a=n[s];o.has(a)||(t.getElement(a,i),G(i,i,e),r.set(i,3*a),o.add(a))}t.setArray(r).setNormalized(!1)}function Sn(e,t,n,o){const r=J();K(r,e),Z(r,r),Q(r,r);const s=U();for(let e=0;e<n.length;e++){const i=n[e];o.has(i)||(t.getElement(i,s),W(s,s,r),B(s,s),t.setElement(i,s),o.add(i))}}function In(e,t,n,o){const r=U(),s=Y();for(let i=0;i<n.length;i++){const a=n[i];if(o.has(a))continue;t.getElement(a,s);const[c,l,g]=s;r[0]=e[0]*c+e[4]*l+e[8]*g,r[1]=e[1]*c+e[5]*l+e[9]*g,r[2]=e[2]*c+e[6]*l+e[10]*g,B(r,r),s[0]=r[0],s[1]=r[1],s[2]=r[2],t.setElement(a,s),o.add(a)}}const bn=()=>e=>{const t=e.createExtension(C).createUnlit();e.getRoot().listMaterials().forEach(e=>{e.setExtension("KHR_materials_unlit",t)})},wn={},Nn=(e=wn)=>(ee({},wn,e),te("unpartition",async e=>{const t=e.getLogger(),n=e.getRoot().listBuffers()[0];e.getRoot().listAccessors().forEach(e=>e.setBuffer(n)),e.getRoot().listBuffers().forEach((e,t)=>t>0?e.dispose():null),t.debug("unpartition: Complete.")}));function Mn(e,t){const n=e.getGraph(),o=[];for(const e of n.listParentEdges(t)){const t=e.getParent(),r=e.getName()+"Info";for(const e of n.listChildEdges(t)){const t=e.getChild();t instanceof f&&e.getName()===r&&o.push(t)}}return o}export{be as DRACO_DEFAULTS,mt as MESHOPT_DEFAULTS,nt as QUANTIZE_DEFAULTS,Ut as SIMPLIFY_DEFAULTS,hn as TEXTURE_RESIZE_DEFAULTS,dn as TextureResizeFilter,vt as WELD_DEFAULTS,pe as center,de as colorspace,je as createLayoutPlan,Ae as dedup,Te as dequantize,we as draco,Dt as getTextureChannelMask,Ne as inspect,_e as instance,jt as listTextureChannels,Mn as listTextureInfo,Vt as listTextureSlots,dt as meshopt,At as metalRough,cn as mozjpeg,It as normals,ln as oxipng,Nt as partition,Fe as prune,ot as quantize,He as reorder,Rt as resample,$t as sequence,Wt as simplify,Ht as simplifyPrimitive,De as sortPrimitiveWeights,sn as squoosh,un as tangents,An as textureResize,yn as transformMesh,En as transformPrimitive,bn as unlit,Nn as unpartition,Et as unweld,an as webp,Lt as weld,_t as weldPrimitive};
//# sourceMappingURL=functions.modern.js.map
