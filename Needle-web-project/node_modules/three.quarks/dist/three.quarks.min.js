!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";var e,t;e=void 0,t=function(e,t){function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_setPrototypeOf(e,t)}function _getPrototypeOf(e){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(e){return e.__proto__||Object.getPrototypeOf(e)},_getPrototypeOf(e)}function _setPrototypeOf(e,t){return _setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(e,t){return e.__proto__=t,e},_setPrototypeOf(e,t)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _possibleConstructorReturn(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(e)}function _createSuper(e){var t=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function _createSuperInternal(){var i,r=_getPrototypeOf(e);if(t){var n=_getPrototypeOf(this).constructor;i=Reflect.construct(r,arguments,n)}else i=r.apply(this,arguments);return _possibleConstructorReturn(this,i)}}function _slicedToArray(e,t){return function _arrayWithHoles(e){if(Array.isArray(e))return e}(e)||function _iterableToArrayLimit(e,t){var i=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=i){var r,n,o=[],a=!0,s=!1;try{for(i=i.call(e);!(a=(r=i.next()).done)&&(o.push(r.value),!t||o.length!==t);a=!0);}catch(e){s=!0,n=e}finally{try{a||null==i.return||i.return()}finally{if(s)throw n}}return o}}(e,t)||_unsupportedIterableToArray(e,t)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=new Array(t);i<t;i++)r[i]=e[i];return r}function _createForOfIteratorHelper(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var r=0,F=function(){};return{s:F,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,o=!0,a=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return o=e.done,e},e:function(e){a=!0,n=e},f:function(){try{o||null==i.return||i.return()}finally{if(a)throw n}}}}var i=function(e){_inherits(ParticleEmitter,e);var t=_createSuper(ParticleEmitter);function ParticleEmitter(e){var i;return _classCallCheck(this,ParticleEmitter),_defineProperty(_assertThisInitialized(i=t.call(this)),"type","ParticleEmitter"),_defineProperty(_assertThisInitialized(i),"system",void 0),i.system=e,i}return _createClass(ParticleEmitter,[{key:"clone",value:function clone(){var e=this.system.clone();return e.emitter.copy(this,!0),e.emitter}},{key:"dispose",value:function dispose(){}},{key:"extractFromCache",value:function extractFromCache(e){var t=[];for(var i in e){var r=e[i];delete r.metadata,t.push(r)}return t}},{key:"toJSON",value:function toJSON(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=void 0===e||"string"==typeof e,r={};i&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},r.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});var n={};if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),!0===this.castShadow&&(n.castShadow=!0),!0===this.receiveShadow&&(n.receiveShadow=!0),!1===this.visible&&(n.visible=!1),!1===this.frustumCulled&&(n.frustumCulled=!1),0!==this.renderOrder&&(n.renderOrder=this.renderOrder),"{}"!==JSON.stringify(this.userData)&&(n.userData=this.userData),n.layers=this.layers.mask,n.matrix=this.matrix.toArray(),!1===this.matrixAutoUpdate&&(n.matrixAutoUpdate=!1),null!==this.system&&(n.ps=this.system.toJSON(e,t)),this.children.length>0){n.children=[];for(var o=0;o<this.children.length;o++)"ParticleSystemPreview"!==this.children[o].type&&n.children.push(this.children[o].toJSON(e).object)}if(i){var a=this.extractFromCache(e.geometries),s=this.extractFromCache(e.materials),l=this.extractFromCache(e.textures),u=this.extractFromCache(e.images);a.length>0&&(r.geometries=a),s.length>0&&(r.materials=s),l.length>0&&(r.textures=l),u.length>0&&(r.images=u)}return r.object=n,r}}]),ParticleEmitter}(t.Object3D),r=function(){function SpriteParticle(){_classCallCheck(this,SpriteParticle),_defineProperty(this,"parentMatrix",void 0),_defineProperty(this,"startSpeed",0),_defineProperty(this,"startColor",new t.Vector4),_defineProperty(this,"startSize",1),_defineProperty(this,"position",new t.Vector3),_defineProperty(this,"velocity",new t.Vector3),_defineProperty(this,"age",0),_defineProperty(this,"life",1),_defineProperty(this,"size",1),_defineProperty(this,"angularVelocity",void 0),_defineProperty(this,"rotation",0),_defineProperty(this,"color",new t.Vector4),_defineProperty(this,"uvTile",0)}return _createClass(SpriteParticle,[{key:"died",get:function get(){return this.age>=this.life}}]),SpriteParticle}(),n=_createClass((function RecordState(e,t,i){_classCallCheck(this,RecordState),this.position=e,this.size=t,this.color=i})),o=function(){function TrailParticle(){_classCallCheck(this,TrailParticle),_defineProperty(this,"parentMatrix",void 0),_defineProperty(this,"startSpeed",0),_defineProperty(this,"startColor",new t.Vector4),_defineProperty(this,"startSize",1),_defineProperty(this,"position",new t.Vector3),_defineProperty(this,"localPosition",void 0),_defineProperty(this,"velocity",new t.Vector3),_defineProperty(this,"age",0),_defineProperty(this,"life",1),_defineProperty(this,"size",1),_defineProperty(this,"length",100),_defineProperty(this,"color",new t.Vector4),_defineProperty(this,"previous",[]),_defineProperty(this,"uvTile",0)}return _createClass(TrailParticle,[{key:"recordCurrentState",value:function recordCurrentState(){for(this.previous.push(new n(this.position.clone(),this.size,this.color.clone()));this.previous.length>this.length;)this.previous.shift()}},{key:"died",get:function get(){return this.age>=this.life}},{key:"reset",value:function reset(){this.previous.length=0}}]),TrailParticle}(),a=function(){function ConstantValue(e){_classCallCheck(this,ConstantValue),this.value=e,_defineProperty(this,"type",void 0),this.type="value"}return _createClass(ConstantValue,[{key:"genValue",value:function genValue(){return this.value}},{key:"toJSON",value:function toJSON(){return{type:"ConstantValue",value:this.value}}},{key:"clone",value:function clone(){return new ConstantValue(this.value)}}],[{key:"fromJSON",value:function fromJSON(e){return new ConstantValue(e.value)}}]),ConstantValue}(),s=function(){function IntervalValue(e,t){_classCallCheck(this,IntervalValue),this.a=e,this.b=t,_defineProperty(this,"type",void 0),this.type="value"}return _createClass(IntervalValue,[{key:"genValue",value:function genValue(){return t.MathUtils.lerp(this.a,this.b,Math.random())}},{key:"toJSON",value:function toJSON(){return{type:"IntervalValue",a:this.a,b:this.b}}},{key:"clone",value:function clone(){return new IntervalValue(this.a,this.b)}}],[{key:"fromJSON",value:function fromJSON(e){return new IntervalValue(e.a,e.b)}}]),IntervalValue}(),l=function(){function PiecewiseFunction(){_classCallCheck(this,PiecewiseFunction),_defineProperty(this,"functions",void 0),this.functions=new Array}return _createClass(PiecewiseFunction,[{key:"findFunction",value:function findFunction(e){for(var t=0,i=0,r=this.functions.length-1;i+1<r;)if(t=Math.floor((i+r)/2),e<this.getStartX(t))r=t-1;else{if(!(e>this.getEndX(t)))return t;i=t+1}for(var n=i;n<=r;n++)if(e>=this.functions[n][1]&&e<=this.getEndX(n))return n;return-1}},{key:"getStartX",value:function getStartX(e){return this.functions[e][1]}},{key:"setStartX",value:function setStartX(e,t){e>0&&(this.functions[e][1]=t)}},{key:"getEndX",value:function getEndX(e){return e+1<this.functions.length?this.functions[e+1][1]:1}},{key:"setEndX",value:function setEndX(e,t){e+1<this.functions.length&&(this.functions[e+1][1]=t)}},{key:"insertFunction",value:function insertFunction(e,t){var i=this.findFunction(e);this.functions.splice(i+1,0,[t,e])}},{key:"removeFunction",value:function removeFunction(e){return this.functions.splice(e,1)[0][0]}},{key:"getFunction",value:function getFunction(e){return this.functions[e][0]}},{key:"setFunction",value:function setFunction(e,t){this.functions[e][0]=t}},{key:"numOfFunctions",get:function get(){return this.functions.length}}]),PiecewiseFunction}(),u=function(){function Bezier(e,t,i,r){_classCallCheck(this,Bezier),_defineProperty(this,"p",void 0),this.p=[e,t,i,r]}return _createClass(Bezier,[{key:"genValue",value:function genValue(e){var t=e*e,i=e*e*e,r=1-e,n=r*r,o=n*r;return this.p[0]*o+this.p[1]*n*e*3+this.p[2]*r*t*3+this.p[3]*i}},{key:"derivativeCoefficients",value:function derivativeCoefficients(e){for(var t=[],i=e,r=i.length-1;r>0;r--){for(var n=[],o=0;o<r;o++){var a=r*(i[o+1]-i[o]);n.push(a)}t.push(n),i=n}return t}},{key:"getSlope",value:function getSlope(e){var t=this.derivativeCoefficients(this.p)[0],i=1-e,r=i*e*2,n=e*e;return i*i*t[0]+r*t[1]+n*t[2]}},{key:"controlCurve",value:function controlCurve(e,t){this.p[1]=e/3+this.p[0],this.p[2]=this.p[3]-t/3}},{key:"hull",value:function hull(e){var t,i=this.p,r=[],n=[],o=0,a=0,s=0;for(n[o++]=i[0],n[o++]=i[1],n[o++]=i[2],n[o++]=i[3];i.length>1;){for(r=[],a=0,s=i.length-1;a<s;a++)t=e*i[a]+(1-e)*i[a+1],n[o++]=t,r.push(t);i=r}return n}},{key:"split",value:function split(e){var t=this.hull(e);return{left:new Bezier(t[0],t[4],t[7],t[9]),right:new Bezier(t[9],t[8],t[6],t[3]),span:t}}},{key:"clone",value:function clone(){return new Bezier(this.p[0],this.p[1],this.p[2],this.p[3])}},{key:"toJSON",value:function toJSON(){return{p0:this.p[0],p1:this.p[1],p2:this.p[2],p3:this.p[3]}}}],[{key:"fromJSON",value:function fromJSON(e){return new Bezier(e.p0,e.p1,e.p2,e.p3)}}]),Bezier}(),c=function(e){_inherits(PiecewiseBezier,e);var t=_createSuper(PiecewiseBezier);function PiecewiseBezier(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[[new u(0,1/3,1/3*2,1),0]];return _classCallCheck(this,PiecewiseBezier),_defineProperty(_assertThisInitialized(e=t.call(this)),"type",void 0),e.type="function",e.functions=i,e}return _createClass(PiecewiseBezier,[{key:"genValue",value:function genValue(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=this.findFunction(e);return-1===t?(console.error(e),0):this.functions[t][0].genValue((e-this.getStartX(t))/(this.getEndX(t)-this.getStartX(t)))}},{key:"toSVG",value:function toSVG(e,t){if(t<1)return"";for(var i=["M",0,this.functions[0][0].p[0]].join(" "),r=1/t;r<=1;r+=1/t)i=[i,"L",r*e,this.genValue(r)].join(" ");return i}},{key:"toJSON",value:function toJSON(){return{type:"PiecewiseBezier",functions:this.functions.map((function(e){var t=_slicedToArray(e,2),i=t[0],r=t[1];return{function:i.toJSON(),start:r}}))}}},{key:"clone",value:function clone(){return new PiecewiseBezier(this.functions.map((function(e){var t=_slicedToArray(e,2),i=t[0],r=t[1];return[i.clone(),r]})))}}],[{key:"fromJSON",value:function fromJSON(e){return new PiecewiseBezier(e.functions.map((function(e){return[u.fromJSON(e.function),e.start]})))}}]),PiecewiseBezier}(l),d=function(){function RandomQuatGenerator(){_classCallCheck(this,RandomQuatGenerator),_defineProperty(this,"type",void 0),this.type="rotation"}return _createClass(RandomQuatGenerator,[{key:"genValue",value:function genValue(e,t){var i,r,n,o,a,s,l;do{n=(i=2*Math.random()-1)*i+(r=2*Math.random()-1)*r}while(n>1);do{s=(o=2*Math.random()-1)*o+(a=2*Math.random()-1)*a}while(s>1);return l=Math.sqrt((1-n)/s),e.set(i,r,l*o,l*a),e}},{key:"toJSON",value:function toJSON(){return{type:"RandomQuat"}}},{key:"clone",value:function clone(){return new RandomQuatGenerator}}],[{key:"fromJSON",value:function fromJSON(e){return new RandomQuatGenerator}}]),RandomQuatGenerator}(),h=function(){function AxisAngleGenerator(e,t){_classCallCheck(this,AxisAngleGenerator),this.axis=e,this.angle=t,_defineProperty(this,"type",void 0),this.type="rotation"}return _createClass(AxisAngleGenerator,[{key:"genValue",value:function genValue(e,t){return e.setFromAxisAngle(this.axis,this.angle.genValue(t))}},{key:"toJSON",value:function toJSON(){return{type:"AxisAngle",axis:{x:this.axis.x,y:this.axis.y,z:this.axis.z},angle:this.angle.toJSON()}}},{key:"clone",value:function clone(){return new AxisAngleGenerator(this.axis.clone(),this.angle.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new AxisAngleGenerator(e.axis,ValueGeneratorFromJSON(e.angle))}}]),AxisAngleGenerator}();function RotationGeneratorFromJSON(e){switch(e.type){case"AxisAngle":return h.fromJSON(e);case"RandomQuat":return d.fromJSON(e);default:return new d}}function ValueGeneratorFromJSON(e){switch(e.type){case"ConstantValue":return a.fromJSON(e);case"IntervalValue":return s.fromJSON(e);case"PiecewiseBezier":return c.fromJSON(e);default:return new a(0)}}function GeneratorFromJSON(e){switch(e.type){case"ConstantValue":case"IntervalValue":case"PiecewiseBezier":return ValueGeneratorFromJSON(e);case"AxisAngle":case"RandomQuat":return RotationGeneratorFromJSON(e);default:return new a(0)}}var f=function ColorToJSON(e){return{r:e.x,g:e.y,b:e.z,a:e.w}},p=function JSONToColor(e){return new t.Vector4(e.r,e.g,e.b,e.a)},y=function(){function RandomColor(e,t){_classCallCheck(this,RandomColor),this.a=e,this.b=t,_defineProperty(this,"type",void 0),this.type="value"}return _createClass(RandomColor,[{key:"genColor",value:function genColor(e){var t=Math.random();return e.copy(this.a).lerp(this.b,t)}},{key:"toJSON",value:function toJSON(){return{type:"RandomColor",a:f(this.a),b:f(this.b)}}},{key:"clone",value:function clone(){return new RandomColor(this.a.clone(),this.b.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new RandomColor(p(e.a),p(e.b))}}]),RandomColor}(),v=function(){function ColorRange(e,t){_classCallCheck(this,ColorRange),this.a=e,this.b=t,_defineProperty(this,"type",void 0),this.type="function"}return _createClass(ColorRange,[{key:"genColor",value:function genColor(e,t){return e.copy(this.a).lerp(this.b,t)}},{key:"toJSON",value:function toJSON(){return{type:"ColorRange",a:f(this.a),b:f(this.b)}}},{key:"clone",value:function clone(){return new ColorRange(this.a.clone(),this.b.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new ColorRange(p(e.a),p(e.b))}}]),ColorRange}(),m=function(){function ConstantColor(e){_classCallCheck(this,ConstantColor),this.color=e,_defineProperty(this,"type",void 0),this.type="value"}return _createClass(ConstantColor,[{key:"genColor",value:function genColor(e){return e.copy(this.color)}},{key:"toJSON",value:function toJSON(){return{type:"ConstantColor",color:f(this.color)}}},{key:"clone",value:function clone(){return new ConstantColor(this.color.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new ConstantColor(p(e.color))}}]),ConstantColor}();function ColorGeneratorFromJSON(e){switch(e.type){case"ConstantColor":return m.fromJSON(e);case"ColorRange":return v.fromJSON(e);case"RandomColor":return y.fromJSON(e);default:return new m(new t.Vector4(1,1,1,1))}}var g=function(e){_inherits(Gradient,e);var i=_createSuper(Gradient);function Gradient(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[[new v(new t.Vector4(0,0,0,1),new t.Vector4(1,1,1,1)),0]];return _classCallCheck(this,Gradient),_defineProperty(_assertThisInitialized(e=i.call(this)),"type",void 0),e.type="function",e.functions=r,e}return _createClass(Gradient,[{key:"genColor",value:function genColor(e,t){var i=this.findFunction(t);return-1===i?(console.error(t),e.copy(this.functions[0][0].a)):this.getFunction(i).genColor(e,(t-this.getStartX(i))/(this.getEndX(i)-this.getStartX(i)))}},{key:"toJSON",value:function toJSON(){return{type:"Gradient",functions:this.functions.map((function(e){var t=_slicedToArray(e,2),i=t[0],r=t[1];return{function:i.toJSON(),start:r}}))}}},{key:"clone",value:function clone(){return new Gradient(this.functions.map((function(e){var t=_slicedToArray(e,2),i=t[0],r=t[1];return[i.clone(),r]})))}}],[{key:"fromJSON",value:function fromJSON(e){return new Gradient(e.functions.map((function(e){return[v.fromJSON(e.function),e.start]})))}}]),Gradient}(l),S=function(){function ColorOverLife(e){_classCallCheck(this,ColorOverLife),this.color=e,_defineProperty(this,"type","ColorOverLife")}return _createClass(ColorOverLife,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){this.color.genColor(e.color,e.age/e.life),e.color.x*=e.startColor.x,e.color.y*=e.startColor.y,e.color.z*=e.startColor.z,e.color.w*=e.startColor.w}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,color:this.color.toJSON()}}},{key:"clone",value:function clone(){return new ColorOverLife(this.color.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new ColorOverLife(ColorGeneratorFromJSON(e.color))}}]),ColorOverLife}(),_=function(){function RotationOverLife(e,i){_classCallCheck(this,RotationOverLife),this.angularVelocity=e,this.dynamic=i,_defineProperty(this,"type","RotationOverLife"),_defineProperty(this,"tempQuat",new t.Quaternion)}return _createClass(RotationOverLife,[{key:"initialize",value:function initialize(e){!this.dynamic&&e instanceof r&&(e.angularVelocity=this.angularVelocity.genValue())}},{key:"update",value:function update(e,t){this.dynamic?e.rotation+=t*this.angularVelocity.genValue(e.age/e.life):e instanceof r&&(e.rotation+=t*e.angularVelocity)}},{key:"toJSON",value:function toJSON(){return{type:this.type,angularVelocity:this.angularVelocity.toJSON(),dynamic:this.dynamic}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new RotationOverLife(this.angularVelocity.clone(),this.dynamic)}}],[{key:"fromJSON",value:function fromJSON(e){return new RotationOverLife(ValueGeneratorFromJSON(e.angularVelocity),e.dynamic)}}]),RotationOverLife}(),O=function(){function SizeOverLife(e){_classCallCheck(this,SizeOverLife),this.size=e,_defineProperty(this,"type","SizeOverLife")}return _createClass(SizeOverLife,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e){e.size=e.startSize*this.size.genValue(e.age/e.life)}},{key:"toJSON",value:function toJSON(){return{type:this.type,size:this.size.toJSON()}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new SizeOverLife(this.size.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new SizeOverLife(ValueGeneratorFromJSON(e.size))}}]),SizeOverLife}(),x=function(){function SpeedOverLife(e){_classCallCheck(this,SpeedOverLife),this.speed=e,_defineProperty(this,"type","SpeedOverLife")}return _createClass(SpeedOverLife,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e){e.velocity.normalize().multiplyScalar(e.startSpeed*this.speed.genValue(e.age/e.life))}},{key:"toJSON",value:function toJSON(){return{type:this.type,speed:this.speed.toJSON()}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new SpeedOverLife(this.speed.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new SpeedOverLife(ValueGeneratorFromJSON(e.speed))}}]),SpeedOverLife}(),w=function(){function FrameOverLife(e){_classCallCheck(this,FrameOverLife),this.frame=e,_defineProperty(this,"type","FrameOverLife")}return _createClass(FrameOverLife,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){e.uvTile=Math.floor(this.frame.genValue(e.age/e.life))}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,frame:this.frame.toJSON()}}},{key:"clone",value:function clone(){return new FrameOverLife(this.frame.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new FrameOverLife(ValueGeneratorFromJSON(e.frame))}}]),FrameOverLife}();new t.Vector3(0,0,1);var P=function(){function OrbitOverLife(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new t.Vector3(0,1,0);_classCallCheck(this,OrbitOverLife),this.orbitSpeed=e,this.axis=i,_defineProperty(this,"type","OrbitOverLife"),_defineProperty(this,"rotation",void 0),_defineProperty(this,"line",void 0),_defineProperty(this,"temp",new t.Vector3),this.rotation=new t.Quaternion,this.line=new t.Line3}return _createClass(OrbitOverLife,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,i){this.line.set(new t.Vector3(0,0,0),this.axis),this.line.closestPointToPoint(e.position,!1,this.temp),this.rotation.setFromAxisAngle(this.axis,this.orbitSpeed.genValue(e.age/e.life)*i),e.position.sub(this.temp),e.position.applyQuaternion(this.rotation),e.position.add(this.temp)}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,orbitSpeed:this.orbitSpeed.toJSON(),axis:[this.axis.x,this.axis.y,this.axis.z]}}},{key:"clone",value:function clone(){return new OrbitOverLife(this.orbitSpeed.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new OrbitOverLife(ValueGeneratorFromJSON(e.orbitSpeed),e.axis?new t.Vector3(e.axis[0],e.axis[1],e.axis[2]):void 0)}}]),OrbitOverLife}(),C=function(){function ApplyForce(e,t){_classCallCheck(this,ApplyForce),this.direction=e,this.force=t,_defineProperty(this,"type","ApplyForce")}return _createClass(ApplyForce,[{key:"initialize",value:function initialize(e){e.force=this.force.genValue()}},{key:"update",value:function update(e,t){e.velocity.addScaledVector(this.direction,e.force*t)}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,direction:[this.direction.x,this.direction.y,this.direction.z],force:this.force.toJSON()}}},{key:"clone",value:function clone(){return new ApplyForce(this.direction.clone(),this.force.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new ApplyForce(new t.Vector3(e.direction[0],e.direction[1],e.direction[2]),ValueGeneratorFromJSON(e.force))}}]),ApplyForce}(),b=function(){function GravityForce(e,i){_classCallCheck(this,GravityForce),this.center=e,this.magnitude=i,_defineProperty(this,"type","GravityForce"),_defineProperty(this,"temp",new t.Vector3)}return _createClass(GravityForce,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){this.temp.copy(this.center).sub(e.position).normalize(),e.velocity.addScaledVector(this.temp,this.magnitude/e.position.distanceToSquared(this.center)*t)}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,center:[this.center.x,this.center.y,this.center.z],magnitude:this.magnitude}}},{key:"clone",value:function clone(){return new GravityForce(this.center.clone(),this.magnitude)}}],[{key:"fromJSON",value:function fromJSON(e){return new GravityForce(new t.Vector3(e.center[0],e.center[1],e.center[2]),e.magnitude)}}]),GravityForce}(),B=function(){function WidthOverLength(e){_classCallCheck(this,WidthOverLength),this.width=e,_defineProperty(this,"type","WidthOverLength")}return _createClass(WidthOverLength,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e){if(e instanceof o)for(var t=0;t<e.previous.length;t++)e.previous[t].size=this.width.genValue((e.previous.length-t)/e.length)}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,width:this.width.toJSON()}}},{key:"clone",value:function clone(){return new WidthOverLength(this.width.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new WidthOverLength(ValueGeneratorFromJSON(e.width))}}]),WidthOverLength}();new t.Vector3(0,0,1);var k=function(){function ChangeEmitDirection(e){_classCallCheck(this,ChangeEmitDirection),this.angle=e,_defineProperty(this,"type","ChangeEmitDirection"),_defineProperty(this,"_temp",new t.Vector3),_defineProperty(this,"_q",new t.Quaternion)}return _createClass(ChangeEmitDirection,[{key:"initialize",value:function initialize(e){var t=e.velocity.length();0!=t&&(e.velocity.normalize(),0===e.velocity.x&&0===e.velocity.y?this._temp.set(0,e.velocity.z,0):this._temp.set(-e.velocity.y,e.velocity.x,0),this._q.setFromAxisAngle(this._temp.normalize(),this.angle.genValue()),this._temp.copy(e.velocity),e.velocity.applyQuaternion(this._q),this._q.setFromAxisAngle(this._temp,Math.random()*Math.PI*2),e.velocity.applyQuaternion(this._q),e.velocity.setLength(t))}},{key:"update",value:function update(e,t){}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,angle:this.angle.toJSON()}}},{key:"clone",value:function clone(){return new ChangeEmitDirection(this.angle)}}],[{key:"fromJSON",value:function fromJSON(e){return new ChangeEmitDirection(ValueGeneratorFromJSON(e.angle))}}]),ChangeEmitDirection}(),M=new t.Vector3(1,1,1),N=new t.Vector3(0,0,1),z=function(){function EmitSubParticleSystem(e,i,r){_classCallCheck(this,EmitSubParticleSystem),this.particleSystem=e,this.useVelocityAsBasis=i,this.subParticleSystem=r,_defineProperty(this,"type","EmitSubParticleSystem"),_defineProperty(this,"q_",new t.Quaternion),_defineProperty(this,"v_",new t.Vector3),_defineProperty(this,"v2_",new t.Vector3),this.subParticleSystem&&(this.subParticleSystem.system.onlyUsedByOther=!0)}return _createClass(EmitSubParticleSystem,[{key:"initialize",value:function initialize(e){e.emissionState={burstIndex:0,burstWaveIndex:0,time:0,waitEmiting:0,matrix:new t.Matrix4}}},{key:"update",value:function update(e,i){if(this.subParticleSystem&&e.emissionState){var r,n=e.emissionState.matrix;if(void 0===e.rotation||this.useVelocityAsBasis)if(0!==e.velocity.x||0!==e.velocity.y||1!==e.velocity.z&&0!==e.velocity.z){this.v_.copy(N).cross(e.velocity),this.v2_.copy(e.velocity).cross(this.v_);var o=this.v_.length(),a=this.v2_.length();n.set(this.v_.x/o,this.v2_.x/a,e.velocity.x,e.position.x,this.v_.y/o,this.v2_.y/a,e.velocity.y,e.position.y,this.v_.z/o,this.v2_.z/a,e.velocity.z,e.position.z,0,0,0,1)}else n.set(1,0,0,e.position.x,0,1,0,e.position.y,0,0,1,e.position.z,0,0,0,1);else e.rotation instanceof t.Quaternion?r=e.rotation:(this.q_.setFromAxisAngle(N,e.rotation),r=this.q_),n.compose(e.position,r,M);this.particleSystem.worldSpace||n.multiplyMatrices(this.particleSystem.emitter.matrixWorld,n),this.subParticleSystem.system.emit(i,e.emissionState,n)}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,subParticleSystem:this.subParticleSystem?this.subParticleSystem.uuid:"",useVelocityAsBasis:this.useVelocityAsBasis}}},{key:"clone",value:function clone(){return new EmitSubParticleSystem(this.particleSystem,this.useVelocityAsBasis,this.subParticleSystem)}}],[{key:"fromJSON",value:function fromJSON(e,t){return new EmitSubParticleSystem(t,e.useVelocityAsBasis,void 0)}}]),EmitSubParticleSystem}(),T=.5*(Math.sqrt(3)-1),J=(3-Math.sqrt(3))/6,A=1/6,R=(Math.sqrt(5)-1)/4,V=(5-Math.sqrt(5))/20,E=new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),L=new Float32Array([0,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,1,0,1,1,1,0,1,-1,1,0,-1,1,1,0,-1,-1,-1,0,1,1,-1,0,1,-1,-1,0,-1,1,-1,0,-1,-1,1,1,0,1,1,1,0,-1,1,-1,0,1,1,-1,0,-1,-1,1,0,1,-1,1,0,-1,-1,-1,0,1,-1,-1,0,-1,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,0]),U=function(){function SimplexNoise(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Math.random;_classCallCheck(this,SimplexNoise),_defineProperty(this,"p",void 0),_defineProperty(this,"perm",void 0),_defineProperty(this,"permMod12",void 0);var t="function"==typeof e?e:alea(e);this.p=buildPermutationTable(t),this.perm=new Uint8Array(512),this.permMod12=new Uint8Array(512);for(var i=0;i<512;i++)this.perm[i]=this.p[255&i],this.permMod12[i]=this.perm[i]%12}return _createClass(SimplexNoise,[{key:"noise2D",value:function noise2D(e,t){var i,r,n=this.permMod12,o=this.perm,a=0,s=0,l=0,u=(e+t)*T,c=Math.floor(e+u),d=Math.floor(t+u),h=(c+d)*J,f=e-(c-h),p=t-(d-h);f>p?(i=1,r=0):(i=0,r=1);var y=f-i+J,v=p-r+J,m=f-1+2*J,g=p-1+2*J,S=255&c,_=255&d,O=.5-f*f-p*p;if(O>=0){var x=3*n[S+o[_]];a=(O*=O)*O*(E[x]*f+E[x+1]*p)}var w=.5-y*y-v*v;if(w>=0){var P=3*n[S+i+o[_+r]];s=(w*=w)*w*(E[P]*y+E[P+1]*v)}var C=.5-m*m-g*g;if(C>=0){var b=3*n[S+1+o[_+1]];l=(C*=C)*C*(E[b]*m+E[b+1]*g)}return 70*(a+s+l)}},{key:"noise3D",value:function noise3D(e,t,i){var r,n,o,a,s,l,u,c,d,h,f=this.permMod12,p=this.perm,y=.3333333333333333*(e+t+i),v=Math.floor(e+y),m=Math.floor(t+y),g=Math.floor(i+y),S=(v+m+g)*A,_=e-(v-S),O=t-(m-S),x=i-(g-S);_>=O?O>=x?(s=1,l=0,u=0,c=1,d=1,h=0):_>=x?(s=1,l=0,u=0,c=1,d=0,h=1):(s=0,l=0,u=1,c=1,d=0,h=1):O<x?(s=0,l=0,u=1,c=0,d=1,h=1):_<x?(s=0,l=1,u=0,c=0,d=1,h=1):(s=0,l=1,u=0,c=1,d=1,h=0);var w=_-s+A,P=O-l+A,C=x-u+A,b=_-c+2*A,B=O-d+2*A,k=x-h+2*A,M=_-1+.5,N=O-1+.5,z=x-1+.5,T=255&v,J=255&m,R=255&g,V=.6-_*_-O*O-x*x;if(V<0)r=0;else{var L=3*f[T+p[J+p[R]]];r=(V*=V)*V*(E[L]*_+E[L+1]*O+E[L+2]*x)}var U=.6-w*w-P*P-C*C;if(U<0)n=0;else{var I=3*f[T+s+p[J+l+p[R+u]]];n=(U*=U)*U*(E[I]*w+E[I+1]*P+E[I+2]*C)}var G=.6-b*b-B*B-k*k;if(G<0)o=0;else{var D=3*f[T+c+p[J+d+p[R+h]]];o=(G*=G)*G*(E[D]*b+E[D+1]*B+E[D+2]*k)}var X=.6-M*M-N*N-z*z;if(X<0)a=0;else{var j=3*f[T+1+p[J+1+p[R+1]]];a=(X*=X)*X*(E[j]*M+E[j+1]*N+E[j+2]*z)}return 32*(r+n+o+a)}},{key:"noise4D",value:function noise4D(e,t,i,r){var n,o,a,s,l,u=this.perm,c=(e+t+i+r)*R,d=Math.floor(e+c),h=Math.floor(t+c),f=Math.floor(i+c),p=Math.floor(r+c),y=(d+h+f+p)*V,v=e-(d-y),m=t-(h-y),g=i-(f-y),S=r-(p-y),_=0,O=0,x=0,w=0;v>m?_++:O++,v>g?_++:x++,v>S?_++:w++,m>g?O++:x++,m>S?O++:w++,g>S?x++:w++;var P=_>=3?1:0,C=O>=3?1:0,b=x>=3?1:0,B=w>=3?1:0,k=_>=2?1:0,M=O>=2?1:0,N=x>=2?1:0,z=w>=2?1:0,T=_>=1?1:0,J=O>=1?1:0,A=x>=1?1:0,E=w>=1?1:0,U=v-P+V,I=m-C+V,G=g-b+V,D=S-B+V,X=v-k+2*V,j=m-M+2*V,Q=g-N+2*V,W=S-z+2*V,q=v-T+3*V,Y=m-J+3*V,Z=g-A+3*V,H=S-E+3*V,K=v-1+4*V,$=m-1+4*V,ee=g-1+4*V,te=S-1+4*V,ie=255&d,re=255&h,ne=255&f,oe=255&p,ae=.6-v*v-m*m-g*g-S*S;if(ae<0)n=0;else{var se=u[ie+u[re+u[ne+u[oe]]]]%32*4;n=(ae*=ae)*ae*(L[se]*v+L[se+1]*m+L[se+2]*g+L[se+3]*S)}var le=.6-U*U-I*I-G*G-D*D;if(le<0)o=0;else{var ue=u[ie+P+u[re+C+u[ne+b+u[oe+B]]]]%32*4;o=(le*=le)*le*(L[ue]*U+L[ue+1]*I+L[ue+2]*G+L[ue+3]*D)}var ce=.6-X*X-j*j-Q*Q-W*W;if(ce<0)a=0;else{var de=u[ie+k+u[re+M+u[ne+N+u[oe+z]]]]%32*4;a=(ce*=ce)*ce*(L[de]*X+L[de+1]*j+L[de+2]*Q+L[de+3]*W)}var he=.6-q*q-Y*Y-Z*Z-H*H;if(he<0)s=0;else{var fe=u[ie+T+u[re+J+u[ne+A+u[oe+E]]]]%32*4;s=(he*=he)*he*(L[fe]*q+L[fe+1]*Y+L[fe+2]*Z+L[fe+3]*H)}var pe=.6-K*K-$*$-ee*ee-te*te;if(pe<0)l=0;else{var ye=u[ie+1+u[re+1+u[ne+1+u[oe+1]]]]%32*4;l=(pe*=pe)*pe*(L[ye]*K+L[ye+1]*$+L[ye+2]*ee+L[ye+3]*te)}return 27*(n+o+a+s+l)}}]),SimplexNoise}();function buildPermutationTable(e){for(var t=new Uint8Array(256),i=0;i<256;i++)t[i]=i;for(var r=0;r<255;r++){var n=r+~~(e()*(256-r)),o=t[r];t[r]=t[n],t[n]=o}return t}function alea(e){var t=0,i=0,r=0,n=1,o=function masher(){var e=4022871197;return function(t){t=t.toString();for(var i=0;i<t.length;i++){var r=.02519603282416938*(e+=t.charCodeAt(i));r-=e=r>>>0,e=(r*=e)>>>0,e+=4294967296*(r-=e)}return 2.3283064365386963e-10*(e>>>0)}}();return t=o(" "),i=o(" "),r=o(" "),(t-=o(e))<0&&(t+=1),(i-=o(e))<0&&(i+=1),(r-=o(e))<0&&(r+=1),function(){var e=2091639*t+2.3283064365386963e-10*n;return t=i,i=r,r=e-(n=0|e)}}var I=function(){function TurbulenceField(e,i,r){_classCallCheck(this,TurbulenceField),this.scale=e,this.power=i,this.fieldShift=r,_defineProperty(this,"type","TurbulenceField"),_defineProperty(this,"generator",new U),_defineProperty(this,"offset",[new t.Vector3,new t.Vector3,new t.Vector3]),_defineProperty(this,"temp",new t.Vector3),this.offset[0].x=Math.random()/this.scale.x,this.offset[1].x=Math.random()/this.scale.x,this.offset[2].x=Math.random()/this.scale.x,this.offset[0].y=Math.random()/this.scale.y,this.offset[1].y=Math.random()/this.scale.y,this.offset[2].y=Math.random()/this.scale.y,this.offset[0].z=Math.random()/this.scale.z,this.offset[1].z=Math.random()/this.scale.z,this.offset[2].z=Math.random()/this.scale.z}return _createClass(TurbulenceField,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){var i=e.position.x/this.scale.x,r=e.position.y/this.scale.y,n=e.position.z/this.scale.z;this.temp.set(this.generator.noise3D(this.offset[0].x+i,this.offset[0].y+r,this.offset[0].z+n),this.generator.noise3D(this.offset[1].x+i,this.offset[1].y+r,this.offset[1].z+n),this.generator.noise3D(this.offset[2].x+i,this.offset[2].y+r,this.offset[2].z+n)).multiply(this.power),e.velocity.addScaledVector(this.temp,t)}},{key:"toJSON",value:function toJSON(){return{type:this.type,scale:[this.scale.x,this.scale.y,this.scale.z],power:[this.power.x,this.power.y,this.power.z],fieldShift:[this.fieldShift.x,this.fieldShift.y,this.fieldShift.z]}}},{key:"frameUpdate",value:function frameUpdate(e){this.offset[0].x+=e*this.fieldShift.x,this.offset[0].y+=e*this.fieldShift.y,this.offset[0].z+=e*this.fieldShift.z,this.offset[1].x+=e*this.fieldShift.x,this.offset[1].y+=e*this.fieldShift.y,this.offset[1].z+=e*this.fieldShift.z,this.offset[2].x+=e*this.fieldShift.x,this.offset[2].y+=e*this.fieldShift.y,this.offset[2].z+=e*this.fieldShift.z}},{key:"clone",value:function clone(){return new TurbulenceField(this.scale.clone(),this.power.clone(),this.fieldShift.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new TurbulenceField(new t.Vector3(e.scale[0],e.scale[1],e.scale[2]),new t.Vector3(e.power[0],e.power[1],e.power[2]),new t.Vector3(e.fieldShift[0],e.fieldShift[1],e.fieldShift[2]))}}]),TurbulenceField}(),G=new t.Quaternion,D=function(){function Rotation3DOverLife(e,i){_classCallCheck(this,Rotation3DOverLife),this.angularVelocity=e,this.dynamic=i,_defineProperty(this,"type","Rotation3DOverLife"),_defineProperty(this,"tempQuat",new t.Quaternion)}return _createClass(Rotation3DOverLife,[{key:"initialize",value:function initialize(e){!this.dynamic&&e instanceof r&&(e.angularVelocity=new t.Quaternion,this.angularVelocity.genValue(e.angularVelocity))}},{key:"update",value:function update(e,t){this.dynamic?(this.angularVelocity.genValue(this.tempQuat,e.age/e.life),this.tempQuat.slerpQuaternions(G,this.tempQuat,t),e.rotation.multiply(this.tempQuat)):e instanceof r&&(this.tempQuat.slerpQuaternions(G,e.angularVelocity,t),e.rotation.multiply(this.tempQuat))}},{key:"toJSON",value:function toJSON(){return{type:this.type,angularVelocity:this.angularVelocity.toJSON(),dynamic:this.dynamic}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new Rotation3DOverLife(this.angularVelocity.clone(),this.dynamic)}}],[{key:"fromJSON",value:function fromJSON(e){return new Rotation3DOverLife(RotationGeneratorFromJSON(e.angularVelocity),e.dynamic)}}]),Rotation3DOverLife}(),X={ApplyForce:{type:"ApplyForce",constructor:C,params:[["direction","vec3"],["force","value"]],loadJSON:C.fromJSON},TurbulenceField:{type:"TurbulenceField",constructor:I,params:[["scale","vec3"],["power","vec3"],["fieldShift","vec3"]],loadJSON:I.fromJSON},GravityForce:{type:"GravityForce",constructor:b,params:[["center","vec3"],["magnitude","number"]],loadJSON:b.fromJSON},ColorOverLife:{type:"ColorOverLife",constructor:S,params:[["color","colorFunc"]],loadJSON:S.fromJSON},RotationOverLife:{type:"RotationOverLife",constructor:_,params:[["angularVelocity","valueFunc"],["dynamic","boolean"]],loadJSON:_.fromJSON},Rotation3DOverLife:{type:"Rotation3DOverLife",constructor:D,params:[["angularVelocity","rotationFunc"],["dynamic","boolean"]],loadJSON:D.fromJSON},SizeOverLife:{type:"SizeOverLife",constructor:O,params:[["size","valueFunc"]],loadJSON:O.fromJSON},SpeedOverLife:{type:"SpeedOverLife",constructor:x,params:[["speed","valueFunc"]],loadJSON:x.fromJSON},FrameOverLife:{type:"FrameOverLife",constructor:w,params:[["frame","valueFunc"]],loadJSON:w.fromJSON},OrbitOverLife:{type:"OrbitOverLife",constructor:P,params:[["orbitSpeed","valueFunc"],["axis","vec3"]],loadJSON:P.fromJSON},WidthOverLength:{type:"WidthOverLength",constructor:B,params:[["width","valueFunc"]],loadJSON:B.fromJSON},ChangeEmitDirection:{type:"ChangeEmitDirection",constructor:k,params:[["angle","value"]],loadJSON:k.fromJSON},EmitSubParticleSystem:{type:"EmitSubParticleSystem",constructor:z,params:[["particleSystem","self"],["useVelocityAsBasis","boolean"],["subParticleSystem","particleSystem"]],loadJSON:z.fromJSON}};function BehaviorFromJSON(e,t){return X[e.type].loadJSON(e,t)}var j,Q=function(){function ConeEmitter(){var e,t,i,r,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,ConeEmitter),_defineProperty(this,"type","cone"),_defineProperty(this,"radius",void 0),_defineProperty(this,"arc",void 0),_defineProperty(this,"thickness",void 0),_defineProperty(this,"angle",void 0),this.radius=null!==(e=n.radius)&&void 0!==e?e:10,this.arc=null!==(t=n.arc)&&void 0!==t?t:2*Math.PI,this.thickness=null!==(i=n.thickness)&&void 0!==i?i:1,this.angle=null!==(r=n.angle)&&void 0!==r?r:Math.PI/6}return _createClass(ConeEmitter,[{key:"initialize",value:function initialize(e){var i=Math.random(),r=t.MathUtils.lerp(1-this.thickness,1,Math.random()),n=i*this.arc,o=Math.sqrt(r),a=Math.sin(n),s=Math.cos(n);e.position.x=o*s,e.position.y=o*a,e.position.z=0;var l=this.angle*o;e.velocity.set(0,0,Math.cos(l)).addScaledVector(e.position,Math.sin(l)).multiplyScalar(e.startSpeed),e.position.multiplyScalar(this.radius)}},{key:"toJSON",value:function toJSON(){return{type:"cone",radius:this.radius,arc:this.arc,thickness:this.thickness,angle:this.angle}}},{key:"clone",value:function clone(){return new ConeEmitter({radius:this.radius,arc:this.arc,thickness:this.thickness,angle:this.angle})}}],[{key:"fromJSON",value:function fromJSON(e){return new ConeEmitter(e)}}]),ConeEmitter}(),W=function(){function DonutEmitter(){var e,t,i,r,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,DonutEmitter),_defineProperty(this,"type","donut"),_defineProperty(this,"radius",void 0),_defineProperty(this,"arc",void 0),_defineProperty(this,"thickness",void 0),_defineProperty(this,"angle",void 0),this.radius=null!==(e=n.radius)&&void 0!==e?e:10,this.arc=null!==(t=n.arc)&&void 0!==t?t:2*Math.PI,this.thickness=null!==(i=n.thickness)&&void 0!==i?i:1,this.angle=null!==(r=n.angle)&&void 0!==r?r:Math.PI/6}return _createClass(DonutEmitter,[{key:"initialize",value:function initialize(e){var i=Math.random(),r=t.MathUtils.lerp(this.thickness,1,Math.random()),n=i*this.arc,o=Math.sqrt(r),a=Math.sin(n),s=Math.cos(n);e.position.x=o*s,e.position.y=o*a,e.position.z=0;var l=this.angle*o;e.velocity.set(0,0,Math.cos(l)).addScaledVector(e.position,Math.sin(l)).multiplyScalar(e.startSpeed),e.position.multiplyScalar(this.radius)}},{key:"toJSON",value:function toJSON(){return{type:"donut",radius:this.radius,arc:this.arc,thickness:this.thickness,angle:this.angle}}},{key:"clone",value:function clone(){return new DonutEmitter({radius:this.radius,arc:this.arc,thickness:this.thickness,angle:this.angle})}}],[{key:"fromJSON",value:function fromJSON(e){return new DonutEmitter(e)}}]),DonutEmitter}(),q=function(){function PointEmitter(){_classCallCheck(this,PointEmitter),_defineProperty(this,"type","point")}return _createClass(PointEmitter,[{key:"initialize",value:function initialize(e){var t=Math.random(),i=Math.random(),r=t*Math.PI*2,n=Math.acos(2*i-1),o=Math.cbrt(Math.random()),a=Math.sin(r),s=Math.cos(r),l=Math.sin(n),u=Math.cos(n);e.velocity.x=o*l*s,e.velocity.y=o*l*a,e.velocity.z=o*u,e.velocity.multiplyScalar(e.startSpeed),e.position.setScalar(0)}},{key:"toJSON",value:function toJSON(){return{type:"point"}}},{key:"clone",value:function clone(){return new PointEmitter}}],[{key:"fromJSON",value:function fromJSON(e){return new PointEmitter}}]),PointEmitter}(),Y=function(){function SphereEmitter(){var e,t,i,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,SphereEmitter),_defineProperty(this,"type","sphere"),_defineProperty(this,"radius",void 0),_defineProperty(this,"arc",void 0),_defineProperty(this,"thickness",void 0),this.radius=null!==(e=r.radius)&&void 0!==e?e:10,this.arc=null!==(t=r.arc)&&void 0!==t?t:2*Math.PI,this.thickness=null!==(i=r.thickness)&&void 0!==i?i:1}return _createClass(SphereEmitter,[{key:"initialize",value:function initialize(e){var i=Math.random(),r=Math.random(),n=t.MathUtils.lerp(1-this.thickness,1,Math.random()),o=i*this.arc,a=Math.acos(2*r-1),s=Math.cbrt(n),l=Math.sin(o),u=Math.cos(o),c=Math.sin(a),d=Math.cos(a);e.position.x=s*c*u,e.position.y=s*c*l,e.position.z=s*d,e.velocity.setScalar(0).addScaledVector(e.position,e.startSpeed),e.position.multiplyScalar(this.radius)}},{key:"toJSON",value:function toJSON(){return{type:"sphere",radius:this.radius,arc:this.arc,thickness:this.thickness}}},{key:"clone",value:function clone(){return new SphereEmitter({radius:this.radius,arc:this.arc,thickness:this.thickness})}}],[{key:"fromJSON",value:function fromJSON(e){return new SphereEmitter(e)}}]),SphereEmitter}(),Z=function(){function MeshSurfaceEmitter(e){_classCallCheck(this,MeshSurfaceEmitter),_defineProperty(this,"type","mesh_surface"),_defineProperty(this,"_triangleIndexToArea",[]),_defineProperty(this,"_mesh",void 0),_defineProperty(this,"_tempA",new t.Vector3),_defineProperty(this,"_tempB",new t.Vector3),_defineProperty(this,"_tempC",new t.Vector3),e&&(this.mesh=e)}return _createClass(MeshSurfaceEmitter,[{key:"mesh",get:function get(){return this._mesh},set:function set(e){this._mesh=e;var i=new t.Triangle;this._triangleIndexToArea.length=0;var r=0,n=e.geometry;if(n.getIndex()){var o=n.getIndex().array,a=o.length/3;this._triangleIndexToArea.push(0);for(var s=0;s<a;s++)i.setFromAttributeAndIndices(n.getAttribute("position"),o[3*s],o[3*s+1],o[3*s+2]),r+=i.getArea(),this._triangleIndexToArea.push(r);e.userData.triangleIndexToArea=this._triangleIndexToArea}}},{key:"initialize",value:function initialize(e){if(!this._mesh)return e.position.set(0,0,0),void e.velocity.set(0,0,1).multiplyScalar(e.startSpeed);for(var t=this._triangleIndexToArea.length-1,i=0,r=t,n=Math.random()*this._triangleIndexToArea[t];i+1<r;){var o=Math.floor((i+r)/2);n<this._triangleIndexToArea[o]?r=o:i=o}var a=Math.random(),s=Math.random();a+s>1&&(a=1-a,s=1-s);var l=this._mesh.geometry,u=l.getIndex().array[3*i],c=l.getIndex().array[3*i+1],d=l.getIndex().array[3*i+2],h=l.getAttribute("position");this._tempA.fromBufferAttribute(h,u),this._tempB.fromBufferAttribute(h,c),this._tempC.fromBufferAttribute(h,d),this._tempB.sub(this._tempA),this._tempC.sub(this._tempA),this._tempA.addScaledVector(this._tempB,a).addScaledVector(this._tempC,s),e.position.copy(this._tempA),this._tempA.copy(this._tempB).cross(this._tempC).normalize(),e.velocity.copy(this._tempA).normalize().multiplyScalar(e.startSpeed)}},{key:"toJSON",value:function toJSON(){return{type:"mesh_surface",mesh:this._mesh?this._mesh.uuid:""}}},{key:"clone",value:function clone(){return new MeshSurfaceEmitter(this._mesh)}}],[{key:"fromJSON",value:function fromJSON(e){return new MeshSurfaceEmitter}}]),MeshSurfaceEmitter}(),H={cone:{type:"cone",params:[["radius","number"],["arc","radian"],["thickness","number"],["angle","radian"]],constructor:Q,loadJSON:Q.fromJSON},donut:{type:"donut",params:[["radius","number"],["arc","radian"],["thickness","number"],["angle","radian"]],constructor:W,loadJSON:W.fromJSON},point:{type:"point",params:[],constructor:q,loadJSON:q.fromJSON},sphere:{type:"sphere",params:[["radius","number"],["arc","radian"],["thickness","number"],["angle","radian"]],constructor:Y,loadJSON:Y.fromJSON},mesh_surface:{type:"mesh_surface",params:[["mesh","mesh"]],constructor:Z,loadJSON:Z.fromJSON}};function EmitterFromJSON(e){return H[e.type].loadJSON(e)}e.RenderMode=void 0,(j=e.RenderMode||(e.RenderMode={}))[j.BillBoard=0]="BillBoard",j[j.StretchedBillBoard=1]="StretchedBillBoard",j[j.LocalSpace=2]="LocalSpace",j[j.Trail=3]="Trail";var K=function(e){_inherits(ParticleSystemBatch,e);var t=_createSuper(ParticleSystemBatch);function ParticleSystemBatch(e){var i;return _classCallCheck(this,ParticleSystemBatch),_defineProperty(_assertThisInitialized(i=t.call(this)),"type","ParticleSystemBatch"),_defineProperty(_assertThisInitialized(i),"systems",void 0),_defineProperty(_assertThisInitialized(i),"material",void 0),_defineProperty(_assertThisInitialized(i),"settings",void 0),_defineProperty(_assertThisInitialized(i),"maxParticles",void 0),i.maxParticles=1e3,i.systems=new Set,i.settings={blending:e.blending,instancingGeometry:e.instancingGeometry,renderMode:e.renderMode,renderOrder:e.renderOrder,texture:e.texture,uTileCount:e.uTileCount,vTileCount:e.vTileCount,transparent:e.transparent},i.frustumCulled=!1,i.renderOrder=i.settings.renderOrder,i}return _createClass(ParticleSystemBatch,[{key:"addSystem",value:function addSystem(e){this.systems.add(e)}},{key:"removeSystem",value:function removeSystem(e){this.systems.delete(e)}}]),ParticleSystemBatch}(t.Mesh),$=new t.Vector3(0,0,1),ee=new t.Quaternion,te=new t.PlaneGeometry(1,1,1,1),ie=function(){function ParticleSystem(r,n){var o,s,l,u,c,d,h,f,p,y,v,g,S,_,O,x,w,P,C,b,B,k;_classCallCheck(this,ParticleSystem),_defineProperty(this,"autoDestroy",void 0),_defineProperty(this,"looping",void 0),_defineProperty(this,"duration",void 0),_defineProperty(this,"startLife",void 0),_defineProperty(this,"startSpeed",void 0),_defineProperty(this,"startRotation",void 0),_defineProperty(this,"startSize",void 0),_defineProperty(this,"startColor",void 0),_defineProperty(this,"startTileIndex",void 0),_defineProperty(this,"rendererEmitterSettings",void 0),_defineProperty(this,"emissionOverTime",void 0),_defineProperty(this,"emissionOverDistance",void 0),_defineProperty(this,"emissionBursts",void 0),_defineProperty(this,"onlyUsedByOther",void 0),_defineProperty(this,"worldSpace",void 0),_defineProperty(this,"speedFactor",void 0),_defineProperty(this,"particleNum",void 0),_defineProperty(this,"paused",void 0),_defineProperty(this,"emissionState",void 0),_defineProperty(this,"emitEnded",void 0),_defineProperty(this,"markForDestroy",void 0),_defineProperty(this,"normalMatrix",new t.Matrix3),_defineProperty(this,"behaviors",void 0),_defineProperty(this,"particles",void 0),_defineProperty(this,"emitterShape",void 0),_defineProperty(this,"emitter",void 0),_defineProperty(this,"rendererSettings",void 0),_defineProperty(this,"renderer",void 0),_defineProperty(this,"neededToUpdateRender",void 0),this.renderer=r,this.autoDestroy=void 0!==n.autoDestroy&&n.autoDestroy,this.duration=null!==(o=n.duration)&&void 0!==o?o:1,this.looping=void 0===n.looping||n.looping,this.startLife=null!==(s=n.startLife)&&void 0!==s?s:new a(5),this.startSpeed=null!==(l=n.startSpeed)&&void 0!==l?l:new a(0),this.startRotation=null!==(u=n.startRotation)&&void 0!==u?u:new a(0),this.startSize=null!==(c=n.startSize)&&void 0!==c?c:new a(1),this.startColor=null!==(d=n.startColor)&&void 0!==d?d:new m(new t.Vector4(1,1,1,1)),this.emissionOverTime=null!==(h=n.emissionOverTime)&&void 0!==h?h:new a(10),this.emissionOverDistance=null!==(f=n.emissionOverDistance)&&void 0!==f?f:new a(0),this.emissionBursts=null!==(p=n.emissionBursts)&&void 0!==p?p:[],this.onlyUsedByOther=null!==(y=n.onlyUsedByOther)&&void 0!==y&&y,this.emitterShape=null!==(v=n.shape)&&void 0!==v?v:new Y,this.behaviors=null!==(g=n.behaviors)&&void 0!==g?g:new Array,this.worldSpace=null!==(S=n.worldSpace)&&void 0!==S&&S,this.speedFactor=null!==(_=n.speedFactor)&&void 0!==_?_:0,this.rendererEmitterSettings=null!==(O=n.rendererEmitterSettings)&&void 0!==O?O:{},this.rendererSettings={blending:null!==(x=n.blending)&&void 0!==x?x:t.NormalBlending,transparent:null===(w=n.transparent)||void 0===w||w,instancingGeometry:null!==(P=n.instancingGeometry)&&void 0!==P?P:te,renderMode:null!==(C=n.renderMode)&&void 0!==C?C:e.RenderMode.BillBoard,renderOrder:null!==(b=n.renderOrder)&&void 0!==b?b:0,texture:n.texture,uTileCount:null!==(B=n.uTileCount)&&void 0!==B?B:1,vTileCount:null!==(k=n.vTileCount)&&void 0!==k?k:1},this.neededToUpdateRender=!0,this.particles=new Array,this.startTileIndex=n.startTileIndex||new a(0),this.emitter=new i(this),this.paused=!1,this.particleNum=0,this.emissionState={burstIndex:0,burstWaveIndex:0,time:0,waitEmiting:0},this.emitEnded=!1,this.markForDestroy=!1,this.renderer.addSystem(this)}return _createClass(ParticleSystem,[{key:"texture",get:function get(){return this.rendererSettings.texture},set:function set(e){this.rendererSettings.texture=e,this.neededToUpdateRender=!0}},{key:"uTileCount",get:function get(){return this.rendererSettings.uTileCount},set:function set(e){this.rendererSettings.uTileCount=e,this.neededToUpdateRender=!0}},{key:"vTileCount",get:function get(){return this.rendererSettings.vTileCount},set:function set(e){this.rendererSettings.vTileCount=e,this.neededToUpdateRender=!0}},{key:"instancingGeometry",get:function get(){return this.rendererSettings.instancingGeometry},set:function set(e){this.restart(),this.particles.length=0,this.rendererSettings.instancingGeometry=e,this.neededToUpdateRender=!0}},{key:"renderMode",get:function get(){return this.rendererSettings.renderMode},set:function set(i){if((this.rendererSettings.renderMode!=e.RenderMode.Trail&&i===e.RenderMode.Trail||this.rendererSettings.renderMode==e.RenderMode.Trail&&i!==e.RenderMode.Trail)&&(this.restart(),this.particles.length=0),this.rendererSettings.renderMode!==i)switch(i){case e.RenderMode.Trail:this.rendererEmitterSettings={startLength:new a(30),followLocalOrigin:!1};break;case e.RenderMode.LocalSpace:this.rendererEmitterSettings={geometry:new t.PlaneGeometry(1,1)},this.startRotation=new h(new t.Vector3(0,1,0),new a(0));break;case e.RenderMode.BillBoard:case e.RenderMode.StretchedBillBoard:this.rendererEmitterSettings={},this.rendererSettings.renderMode===e.RenderMode.LocalSpace&&(this.startRotation=new a(0))}this.rendererSettings.renderMode=i,this.neededToUpdateRender=!0}},{key:"renderOrder",get:function get(){return this.rendererSettings.renderOrder},set:function set(e){this.rendererSettings.renderOrder=e,this.neededToUpdateRender=!0}},{key:"blending",get:function get(){return this.rendererSettings.blending},set:function set(e){this.rendererSettings.blending=e,this.neededToUpdateRender=!0}},{key:"pause",value:function pause(){this.paused=!0}},{key:"play",value:function play(){this.paused=!1}},{key:"spawn",value:function spawn(i,n,a){ee.setFromRotationMatrix(a);for(var s=0;s<i;s++){for(this.particleNum++;this.particles.length<this.particleNum;)this.rendererSettings.renderMode===e.RenderMode.Trail?this.particles.push(new o):this.particles.push(new r);var l=this.particles[this.particleNum-1];if(this.startColor.genColor(l.startColor,n.time),l.color.copy(l.startColor),l.startSpeed=this.startSpeed.genValue(n.time/this.duration),l.life=this.startLife.genValue(n.time/this.duration),l.age=0,l.startSize=this.startSize.genValue(n.time/this.duration),l.uvTile=Math.floor(this.startTileIndex.genValue()),l.size=l.startSize,this.rendererSettings.renderMode===e.RenderMode.LocalSpace||this.rendererSettings.renderMode===e.RenderMode.BillBoard||this.rendererSettings.renderMode===e.RenderMode.StretchedBillBoard){var u=l;this.rendererSettings.renderMode===e.RenderMode.LocalSpace?(u.rotation instanceof t.Quaternion||(u.rotation=new t.Quaternion),"rotation"===this.startRotation.type?this.startRotation.genValue(u.rotation,n.time/this.duration):u.rotation.setFromAxisAngle($,this.startRotation.genValue(n.time/this.duration))):"rotation"===this.startRotation.type?u.rotation=0:u.rotation=this.startRotation.genValue(n.time/this.duration)}else if(this.rendererSettings.renderMode===e.RenderMode.Trail){var c=l;c.length=this.rendererEmitterSettings.startLength.genValue(n.time/this.duration),c.reset()}if(this.emitterShape.initialize(l),this.rendererSettings.renderMode===e.RenderMode.Trail&&this.rendererEmitterSettings.followLocalOrigin){var d=l;d.localPosition=(new t.Vector3).copy(d.position)}this.worldSpace?(l.position.applyMatrix4(a),l.velocity.applyMatrix3(this.normalMatrix),l.rotation&&l.rotation instanceof t.Quaternion&&l.rotation.multiplyQuaternions(ee,l.rotation)):this.onlyUsedByOther&&(l.parentMatrix=a);for(var h=0;h<this.behaviors.length;h++)this.behaviors[h].initialize(l)}}},{key:"endEmit",value:function endEmit(){this.emitEnded=!0,this.autoDestroy&&(this.markForDestroy=!0)}},{key:"dispose",value:function dispose(){this.renderer.deleteSystem(this),this.emitter.dispose(),this.emitter.parent&&this.emitter.parent.remove(this.emitter)}},{key:"restart",value:function restart(){this.paused=!1,this.particleNum=0,this.emissionState.burstIndex=0,this.emissionState.burstWaveIndex=0,this.emissionState.time=0,this.emissionState.waitEmiting=0,this.emitEnded=!1,this.markForDestroy=!1}},{key:"update",value:function update(t){if(t>.1&&(t=.1),!this.paused)if(this.emitEnded&&0===this.particleNum)this.markForDestroy&&this.emitter.parent&&this.dispose();else{this.neededToUpdateRender&&(this.renderer.updateSystem(this),this.neededToUpdateRender=!1),this.onlyUsedByOther||this.emit(t,this.emissionState,this.emitter.matrixWorld);for(var i=0;i<this.behaviors.length;i++){for(var r=0;r<this.particleNum;r++)this.behaviors[i].update(this.particles[r],t);this.behaviors[i].frameUpdate(t)}for(var n=0;n<this.particleNum;n++)this.rendererEmitterSettings.followLocalOrigin&&this.particles[n].localPosition?(this.particles[n].position.copy(this.particles[n].localPosition),this.particles[n].parentMatrix?this.particles[n].position.applyMatrix4(this.particles[n].parentMatrix):this.particles[n].position.applyMatrix4(this.emitter.matrixWorld)):this.particles[n].position.addScaledVector(this.particles[n].velocity,t),this.particles[n].age+=t;if(this.rendererSettings.renderMode===e.RenderMode.Trail)for(var o=0;o<this.particleNum;o++)this.particles[o].recordCurrentState();for(var a=0;a<this.particleNum;a++){var s=this.particles[a];s.age>=s.life&&(this.particles[a]=this.particles[this.particleNum-1],this.particles[this.particleNum-1]=s,this.particleNum--,a--)}}}},{key:"emit",value:function emit(e,t,i){if(t.time>this.duration&&(this.looping?(t.time-=this.duration,t.burstIndex=0):this.emitEnded||this.onlyUsedByOther||this.endEmit()),this.normalMatrix.getNormalMatrix(i),!this.emitEnded){var r=Math.ceil(t.waitEmiting);this.spawn(r,t,i),t.waitEmiting-=r}for(;t.burstIndex<this.emissionBursts.length&&this.emissionBursts[t.burstIndex].time<=t.time;){if(Math.random()<this.emissionBursts[t.burstIndex].probability){var n=this.emissionBursts[t.burstIndex].count;this.spawn(n,t,i)}t.burstIndex++}this.emitEnded||(t.waitEmiting+=e*this.emissionOverTime.genValue(t.time/this.duration)),t.time+=e}},{key:"toJSON",value:function toJSON(t){var i,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=void 0===t||"string"==typeof t;if(n&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}}),this.texture.toJSON(t),r.useUrlForImage&&void 0!==this.texture.source){var o=this.texture.source;t.images[o.uuid]={uuid:o.uuid,url:this.texture.image.url}}i=this.renderMode===e.RenderMode.Trail?{startLength:this.rendererEmitterSettings.startLength.toJSON(),followLocalOrigin:this.rendererEmitterSettings.followLocalOrigin}:(this.renderMode,e.RenderMode.LocalSpace,{});var a=this.rendererSettings.instancingGeometry;return t.geometries&&!t.geometries[a.uuid]&&(t.geometries[a.uuid]=a.toJSON()),{autoDestroy:this.autoDestroy,looping:this.looping,duration:this.duration,shape:this.emitterShape.toJSON(),startLife:this.startLife.toJSON(),startSpeed:this.startSpeed.toJSON(),startRotation:this.startRotation.toJSON(),startSize:this.startSize.toJSON(),startColor:this.startColor.toJSON(),emissionOverTime:this.emissionOverTime.toJSON(),emissionOverDistance:this.emissionOverDistance.toJSON(),emissionBursts:this.emissionBursts,onlyUsedByOther:this.onlyUsedByOther,instancingGeometry:this.rendererSettings.instancingGeometry.uuid,renderOrder:this.renderOrder,renderMode:this.renderMode,rendererEmitterSettings:i,speedFactor:this.renderMode===e.RenderMode.StretchedBillBoard?this.speedFactor:0,texture:this.texture.uuid,startTileIndex:this.startTileIndex.toJSON(),uTileCount:this.uTileCount,vTileCount:this.vTileCount,blending:this.blending,behaviors:this.behaviors.map((function(e){return e.toJSON()})),worldSpace:this.worldSpace}}},{key:"addBehavior",value:function addBehavior(e){this.behaviors.push(e)}},{key:"getRendererSettings",value:function getRendererSettings(){return this.rendererSettings}},{key:"clone",value:function clone(){var t,i=[],r=_createForOfIteratorHelper(this.emissionBursts);try{for(r.s();!(t=r.n()).done;){var n=t.value,o={};Object.assign(o,n),i.push(o)}}catch(e){r.e(e)}finally{r.f()}var a,s,l=[],u=_createForOfIteratorHelper(this.behaviors);try{for(u.s();!(a=u.n()).done;){var c=a.value;l.push(c.clone())}}catch(e){u.e(e)}finally{u.f()}return s=this.renderMode===e.RenderMode.Trail?{startLength:this.rendererEmitterSettings.startLength.clone(),followLocalOrigin:this.rendererEmitterSettings.followLocalOrigin}:{},new ParticleSystem(this.renderer,{autoDestroy:this.autoDestroy,looping:this.looping,duration:this.duration,shape:this.emitterShape.clone(),startLife:this.startLife.clone(),startSpeed:this.startSpeed.clone(),startRotation:this.startRotation.clone(),startSize:this.startSize.clone(),startColor:this.startColor.clone(),emissionOverTime:this.emissionOverTime.clone(),emissionOverDistance:this.emissionOverDistance.clone(),emissionBursts:i,onlyUsedByOther:this.onlyUsedByOther,instancingGeometry:this.rendererSettings.instancingGeometry,renderMode:this.renderMode,rendererEmitterSettings:s,speedFactor:this.speedFactor,texture:this.texture,startTileIndex:this.startTileIndex,uTileCount:this.uTileCount,vTileCount:this.vTileCount,blending:this.blending,behaviors:l,worldSpace:this.worldSpace})}}],[{key:"fromJSON",value:function fromJSON(t,i,r,n){var o,s=EmitterFromJSON(t.shape);o=t.renderMode===e.RenderMode.Trail?{startLength:ValueGeneratorFromJSON(t.rendererEmitterSettings.startLength),followLocalOrigin:t.rendererEmitterSettings.followLocalOrigin}:(t.renderMode,e.RenderMode.LocalSpace,{});var l=new ParticleSystem(n,{autoDestroy:t.autoDestroy,looping:t.looping,duration:t.duration,shape:s,startLife:ValueGeneratorFromJSON(t.startLife),startSpeed:ValueGeneratorFromJSON(t.startSpeed),startRotation:GeneratorFromJSON(t.startRotation),startSize:ValueGeneratorFromJSON(t.startSize),startColor:ColorGeneratorFromJSON(t.startColor),emissionOverTime:ValueGeneratorFromJSON(t.emissionOverTime),emissionOverDistance:ValueGeneratorFromJSON(t.emissionOverDistance),emissionBursts:t.emissionBursts,onlyUsedByOther:t.onlyUsedByOther,instancingGeometry:i.geometries[t.instancingGeometry],renderMode:t.renderMode,rendererEmitterSettings:o,renderOrder:t.renderOrder,speedFactor:t.speedFactor,texture:i.textures[t.texture],startTileIndex:"number"==typeof t.startTileIndex?new a(t.startTileIndex):ValueGeneratorFromJSON(t.startTileIndex),uTileCount:t.uTileCount,vTileCount:t.vTileCount,blending:t.blending,behaviors:[],worldSpace:t.worldSpace});return l.behaviors=t.behaviors.map((function(e){var t=BehaviorFromJSON(e,l);return"EmitSubParticleSystem"===t.type&&(r[e.subParticleSystem]=t),t})),l}}]),ParticleSystem}(),re="\n\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvarying vec4 vColor;\n\nvoid main() {\n\n    #include <clipping_planes_fragment>\n    \n    vec3 outgoingLight = vec3( 0.0 );\n    vec4 diffuseColor = vColor;\n    \n    #include <logdepthbuf_fragment>\n    \n    #ifdef USE_MAP\n    vec4 texelColor = texture2D( map, vUv);\n    diffuseColor *= texelColor;\n    #endif\n\n    outgoingLight = diffuseColor.rgb;\n\n    gl_FragColor = vec4( outgoingLight, diffuseColor.a );\n    \n    #include <tonemapping_fragment>\n\n}\n";new t.Vector3(0,0,1);var ne=function(i){_inherits(SpriteBatch,i);var r=_createSuper(SpriteBatch);function SpriteBatch(e){var i;return _classCallCheck(this,SpriteBatch),_defineProperty(_assertThisInitialized(i=r.call(this,e)),"geometry",void 0),_defineProperty(_assertThisInitialized(i),"offsetBuffer",void 0),_defineProperty(_assertThisInitialized(i),"rotationBuffer",void 0),_defineProperty(_assertThisInitialized(i),"sizeBuffer",void 0),_defineProperty(_assertThisInitialized(i),"colorBuffer",void 0),_defineProperty(_assertThisInitialized(i),"uvTileBuffer",void 0),_defineProperty(_assertThisInitialized(i),"velocityBuffer",void 0),_defineProperty(_assertThisInitialized(i),"vector_",new t.Vector3),_defineProperty(_assertThisInitialized(i),"quaternion_",new t.Quaternion),_defineProperty(_assertThisInitialized(i),"quaternion2_",new t.Quaternion),_defineProperty(_assertThisInitialized(i),"quaternion3_",new t.Quaternion),_defineProperty(_assertThisInitialized(i),"rotationMat_",new t.Matrix3),_defineProperty(_assertThisInitialized(i),"rotationMat2_",new t.Matrix3),i.maxParticles=1e3,i.setupBuffers(),i.rebuildMaterial(),i}return _createClass(SpriteBatch,[{key:"buildExpandableBuffers",value:function buildExpandableBuffers(){this.offsetBuffer=new t.InstancedBufferAttribute(new Float32Array(3*this.maxParticles),3),this.offsetBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("offset",this.offsetBuffer),this.colorBuffer=new t.InstancedBufferAttribute(new Float32Array(4*this.maxParticles),4),this.colorBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("color",this.colorBuffer),this.settings.renderMode===e.RenderMode.LocalSpace?(this.rotationBuffer=new t.InstancedBufferAttribute(new Float32Array(4*this.maxParticles),4),this.rotationBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("rotation",this.rotationBuffer)):this.settings.renderMode!==e.RenderMode.BillBoard&&this.settings.renderMode!==e.RenderMode.StretchedBillBoard||(this.rotationBuffer=new t.InstancedBufferAttribute(new Float32Array(this.maxParticles),1),this.rotationBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("rotation",this.rotationBuffer)),this.sizeBuffer=new t.InstancedBufferAttribute(new Float32Array(this.maxParticles),1),this.sizeBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("size",this.sizeBuffer),this.uvTileBuffer=new t.InstancedBufferAttribute(new Float32Array(this.maxParticles),1),this.uvTileBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("uvTile",this.uvTileBuffer),this.settings.renderMode===e.RenderMode.StretchedBillBoard&&(this.velocityBuffer=new t.InstancedBufferAttribute(new Float32Array(3*this.maxParticles),3),this.velocityBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("velocity",this.velocityBuffer))}},{key:"setupBuffers",value:function setupBuffers(){this.geometry&&this.geometry.dispose(),this.geometry=new t.InstancedBufferGeometry,this.geometry.setIndex(this.settings.instancingGeometry.getIndex()),this.geometry.setAttribute("position",this.settings.instancingGeometry.getAttribute("position")),this.geometry.setAttribute("uv",this.settings.instancingGeometry.getAttribute("uv")),this.buildExpandableBuffers()}},{key:"expandBuffers",value:function expandBuffers(e){for(;e>=this.maxParticles;)this.maxParticles*=2;this.setupBuffers()}},{key:"rebuildMaterial",value:function rebuildMaterial(){var i={},r={USE_MAP:"",USE_UV:""};i.map=new t.Uniform(this.settings.texture),i.uvTransform=new t.Uniform((new t.Matrix3).copy(this.settings.texture.matrix));var n=this.settings.uTileCount,o=this.settings.vTileCount;if(r.UV_TILE="",i.tileCount=new t.Uniform(new t.Vector2(n,o)),this.settings.renderMode===e.RenderMode.BillBoard||this.settings.renderMode===e.RenderMode.LocalSpace){var a,s;this.settings.renderMode===e.RenderMode.LocalSpace?(a="\n\n#include <uv_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nattribute vec3 offset;\nattribute vec4 rotation;\nattribute float size;\nattribute vec4 color;\nattribute float uvTile;\n\nvarying vec4 vColor;\n\n#ifdef UV_TILE\nuniform vec2 tileCount;\n#endif\n\nvoid main() {\n\n    #ifdef UV_TILE\n        vUv = vec2((mod(uvTile, tileCount.x) + uv.x) * (1.0 / tileCount.x), ((tileCount.y - floor(uvTile / tileCount.x) - 1.0) + uv.y) * (1.0 / tileCount.y));\n    #else\n        #include <uv_vertex>\n    #endif\n    \n    float x2 = rotation.x + rotation.x, y2 = rotation.y + rotation.y, z2 = rotation.z + rotation.z;\n    float xx = rotation.x * x2, xy = rotation.x * y2, xz = rotation.x * z2;\n    float yy = rotation.y * y2, yz = rotation.y * z2, zz = rotation.z * z2;\n    float wx = rotation.w * x2, wy = rotation.w * y2, wz = rotation.w * z2;\n    float sx = size, sy = size, sz = size;\n    \n    mat4 matrix = mat4(( 1.0 - ( yy + zz ) ) * sx, ( xy + wz ) * sx, ( xz - wy ) * sx, 0.0,  // 1. column\n                      ( xy - wz ) * sy, ( 1.0 - ( xx + zz ) ) * sy, ( yz + wx ) * sy, 0.0,  // 2. column\n                      ( xz + wy ) * sz, ( yz - wx ) * sz, ( 1.0 - ( xx + yy ) ) * sz, 0.0,  // 3. column\n                      offset.x, offset.y, offset.z, 1.0);\n    \n    vec4 mvPosition = modelViewMatrix * (matrix * vec4( position, 1.0 ));\n\n\tvColor = color;\n\n\tgl_Position = projectionMatrix * mvPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\n}\n",s=t.DoubleSide):(a="\n\n#include <uv_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nattribute vec3 offset;\nattribute float rotation;\nattribute float size;\nattribute vec4 color;\nattribute float uvTile;\n\nvarying vec4 vColor;\n\n#ifdef UV_TILE\nuniform vec2 tileCount;\n#endif\n\nvoid main() {\n\n    #ifdef UV_TILE\n        vUv = vec2((mod(uvTile, tileCount.x) + uv.x) * (1.0 / tileCount.x), ((tileCount.y - floor(uvTile / tileCount.x) - 1.0) + uv.y) * (1.0 / tileCount.y));\n    #else\n        #include <uv_vertex>\n    #endif\n\t\n    vec4 mvPosition = modelViewMatrix * vec4( offset, 1.0 );\n\t\n    vec2 alignedPosition = ( position.xy ) * size;\n    \n    vec2 rotatedPosition;\n    rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n    rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n    \n    mvPosition.xy += rotatedPosition;\n\n\tvColor = color;\n\n\tgl_Position = projectionMatrix * mvPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\n}\n",s=t.FrontSide),this.material=new t.ShaderMaterial({uniforms:i,defines:r,vertexShader:a,fragmentShader:re,transparent:this.settings.transparent,depthWrite:!this.settings.transparent,blending:this.settings.blending||t.AdditiveBlending,side:s})}else{if(this.settings.renderMode!==e.RenderMode.StretchedBillBoard)throw new Error("render mode unavailable");i.speedFactor=new t.Uniform(1),this.material=new t.ShaderMaterial({uniforms:i,defines:r,vertexShader:"\n\n#include <uv_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nattribute vec3 offset;\nattribute float rotation;\nattribute float size;\nattribute vec4 color;\nattribute vec3 velocity;\nattribute float uvTile;\n\nvarying vec4 vColor;\n\n#ifdef UV_TILE\nuniform vec2 tileCount;\n#endif\n\nuniform float speedFactor;\n\nvoid main() {\n\n    #ifdef UV_TILE\n        vUv = vec2((mod(uvTile, tileCount.x) + uv.x) * (1.0 / tileCount.x), ((tileCount.y - floor(uvTile / tileCount.x) - 1.0) + uv.y) * (1.0 / tileCount.y));\n    #else\n        #include <uv_vertex>\n    #endif\n\t\n    vec4 mvPosition = modelViewMatrix * vec4( offset, 1.0 );\n    vec3 viewVelocity = normalMatrix * velocity;\n\n    vec3 scaledPos = vec3(position.xy * size, position.z);\n    mvPosition.xyz += scaledPos + dot(scaledPos, viewVelocity) * viewVelocity / length(viewVelocity) * speedFactor;\n\n\tvColor = color;\n\n\tgl_Position = projectionMatrix * mvPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\n}\n",fragmentShader:re,transparent:this.settings.transparent,depthWrite:!this.settings.transparent,blending:this.settings.blending||t.AdditiveBlending})}}},{key:"update",value:function update(){var t=this,i=0,r=0;this.systems.forEach((function(e){r+=e.particleNum})),r>this.maxParticles&&this.expandBuffers(r),this.systems.forEach((function(r){var n=r.particles,o=r.particleNum;t.quaternion2_.setFromRotationMatrix(r.emitter.matrixWorld),t.rotationMat_.setFromMatrix4(r.emitter.matrixWorld);for(var a=0;a<o;a++,i++){var s=n[a];if(t.settings.renderMode===e.RenderMode.LocalSpace){var l=void 0;if(r.worldSpace)l=s.rotation;else{var u=void 0;u=s.parentMatrix?t.quaternion3_.setFromRotationMatrix(s.parentMatrix):t.quaternion2_,(l=t.quaternion_).copy(s.rotation).multiply(u)}t.rotationBuffer.setXYZW(i,l.x,l.y,l.z,l.w)}else t.settings.renderMode!==e.RenderMode.StretchedBillBoard&&t.settings.renderMode!==e.RenderMode.BillBoard||t.rotationBuffer.setX(i,s.rotation);var c=void 0;if(r.worldSpace?c=s.position:(c=t.vector_,s.parentMatrix?c.copy(s.position).applyMatrix4(s.parentMatrix):c.copy(s.position).applyMatrix4(r.emitter.matrixWorld)),t.offsetBuffer.setXYZ(i,c.x,c.y,c.z),t.colorBuffer.setXYZW(i,s.color.x,s.color.y,s.color.z,s.color.w),t.sizeBuffer.setX(i,s.size),t.uvTileBuffer.setX(i,s.uvTile),t.settings.renderMode===e.RenderMode.StretchedBillBoard){var d=r.speedFactor,h=void 0;r.worldSpace?h=s.velocity:(h=t.vector_,s.parentMatrix?(t.rotationMat2_.setFromMatrix4(s.parentMatrix),h.copy(s.velocity).applyMatrix3(t.rotationMat2_)):h.copy(s.velocity).applyMatrix3(t.rotationMat_)),t.velocityBuffer.setXYZ(i,h.x*d,h.y*d,h.z*d)}}})),this.geometry.instanceCount=i,i>0&&(this.offsetBuffer.updateRange.count=3*i,this.offsetBuffer.needsUpdate=!0,this.sizeBuffer.updateRange.count=i,this.sizeBuffer.needsUpdate=!0,this.colorBuffer.updateRange.count=4*i,this.colorBuffer.needsUpdate=!0,this.uvTileBuffer.updateRange.count=i,this.uvTileBuffer.needsUpdate=!0,this.settings.renderMode===e.RenderMode.StretchedBillBoard&&(this.velocityBuffer.updateRange.count=3*i,this.velocityBuffer.needsUpdate=!0),this.settings.renderMode===e.RenderMode.LocalSpace?(this.rotationBuffer.updateRange.count=4*i,this.rotationBuffer.needsUpdate=!0):this.settings.renderMode!==e.RenderMode.StretchedBillBoard&&this.settings.renderMode!==e.RenderMode.BillBoard||(this.rotationBuffer.updateRange.count=i,this.rotationBuffer.needsUpdate=!0))}},{key:"dispose",value:function dispose(){this.geometry.dispose()}}]),SpriteBatch}(K);new t.Vector3(0,0,1);var oe=function(i){_inherits(TrailBatch,i);var r=_createSuper(TrailBatch);function TrailBatch(e){var i;return _classCallCheck(this,TrailBatch),_defineProperty(_assertThisInitialized(i=r.call(this,e)),"geometry",void 0),_defineProperty(_assertThisInitialized(i),"positionBuffer",void 0),_defineProperty(_assertThisInitialized(i),"previousBuffer",void 0),_defineProperty(_assertThisInitialized(i),"nextBuffer",void 0),_defineProperty(_assertThisInitialized(i),"uvBuffer",void 0),_defineProperty(_assertThisInitialized(i),"sideBuffer",void 0),_defineProperty(_assertThisInitialized(i),"widthBuffer",void 0),_defineProperty(_assertThisInitialized(i),"colorBuffer",void 0),_defineProperty(_assertThisInitialized(i),"indexBuffer",void 0),_defineProperty(_assertThisInitialized(i),"vector_",new t.Vector3),i.maxParticles=1e4,i.setupBuffers(),i.rebuildMaterial(),i}return _createClass(TrailBatch,[{key:"setupBuffers",value:function setupBuffers(){this.geometry&&this.geometry.dispose(),this.geometry=new t.BufferGeometry,this.indexBuffer=new t.BufferAttribute(new Uint32Array(6*this.maxParticles),1),this.indexBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setIndex(this.indexBuffer),this.positionBuffer=new t.BufferAttribute(new Float32Array(6*this.maxParticles),3),this.positionBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("position",this.positionBuffer),this.previousBuffer=new t.BufferAttribute(new Float32Array(6*this.maxParticles),3),this.previousBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("previous",this.previousBuffer),this.nextBuffer=new t.BufferAttribute(new Float32Array(6*this.maxParticles),3),this.nextBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("next",this.nextBuffer),this.widthBuffer=new t.BufferAttribute(new Float32Array(2*this.maxParticles),1),this.widthBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("width",this.widthBuffer),this.sideBuffer=new t.BufferAttribute(new Float32Array(2*this.maxParticles),1),this.sideBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("side",this.sideBuffer),this.uvBuffer=new t.BufferAttribute(new Float32Array(4*this.maxParticles),2),this.uvBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("uv",this.uvBuffer),this.colorBuffer=new t.BufferAttribute(new Float32Array(8*this.maxParticles),4),this.colorBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("color",this.colorBuffer)}},{key:"expandBuffers",value:function expandBuffers(e){for(;e>=this.maxParticles;)this.maxParticles*=2;this.setupBuffers()}},{key:"rebuildMaterial",value:function rebuildMaterial(){var i={lineWidth:{value:1},map:{value:null},useMap:{value:0},alphaMap:{value:null},useAlphaMap:{value:0},resolution:{value:new t.Vector2(1,1)},sizeAttenuation:{value:1},visibility:{value:1},alphaTest:{value:0},repeat:{value:new t.Vector2(1,1)}},r={USE_MAP:"",USE_UV:""};if(i.map=new t.Uniform(this.settings.texture),i.uvTransform=new t.Uniform((new t.Matrix3).copy(this.settings.texture.matrix)),this.settings.renderMode!==e.RenderMode.Trail)throw new Error("render mode unavailable");this.material=new t.ShaderMaterial({uniforms:i,defines:r,vertexShader:"\n\n#include <uv_pars_vertex>\n#include <clipping_planes_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <fog_pars_vertex>\n\nattribute vec3 previous;\nattribute vec3 next;\nattribute vec4 color;\nattribute float side;\nattribute float width;\n\nuniform vec2 resolution;\nuniform float lineWidth;\nuniform float sizeAttenuation;\n\nvarying vec2 vUV;\nvarying vec4 vColor;\n    \nvec2 fix(vec4 i, float aspect) {\n    vec2 res = i.xy / i.w;\n    res.x *= aspect;\n    return res;\n}\n    \nvoid main() {\n\n    #include <uv_vertex>\n    \n    float aspect = resolution.x / resolution.y;\n\n    vColor = color;\n\n    mat4 m = projectionMatrix * modelViewMatrix;\n    vec4 finalPosition = m * vec4( position, 1.0 );\n    vec4 prevPos = m * vec4( previous, 1.0 );\n    vec4 nextPos = m * vec4( next, 1.0 );\n\n    vec2 currentP = fix( finalPosition, aspect );\n    vec2 prevP = fix( prevPos, aspect );\n    vec2 nextP = fix( nextPos, aspect );\n\n    float w = lineWidth * width;\n\n    vec2 dir;\n    if( nextP == currentP ) dir = normalize( currentP - prevP );\n    else if( prevP == currentP ) dir = normalize( nextP - currentP );\n    else {\n        vec2 dir1 = normalize( currentP - prevP );\n        vec2 dir2 = normalize( nextP - currentP );\n        dir = normalize( dir1 + dir2 );\n\n        vec2 perp = vec2( -dir1.y, dir1.x );\n        vec2 miter = vec2( -dir.y, dir.x );\n        //w = clamp( w / dot( miter, perp ), 0., 4., * lineWidth * width );\n\n    }\n\n    //vec2 normal = ( cross( vec3( dir, 0. ) vec3( 0., 0., 1. ) ) ).xy;\n    vec4 normal = vec4( -dir.y, dir.x, 0., 1. );\n    normal.xy *= .5 * w;\n    normal *= projectionMatrix;\n    if( sizeAttenuation == 0. ) {\n        normal.xy *= finalPosition.w;\n        normal.xy /= ( vec4( resolution, 0., 1. ) * projectionMatrix ).xy;\n    }\n\n    finalPosition.xy += normal.xy * side;\n\n    gl_Position = finalPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t\n    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n    \n\t#include <fog_vertex>\n}",fragmentShader:"\n\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nuniform sampler2D alphaMap;\nuniform float useAlphaMap;\nuniform float visibility;\nuniform float alphaTest;\nuniform vec2 repeat;\n\nvarying vec4 vColor;\n    \nvoid main() {\n    #include <clipping_planes_fragment>\n    #include <logdepthbuf_fragment>\n\n    vec4 c = vColor;\n    \n    #ifdef USE_MAP\n    c *= texture2D( map, vUv * repeat );\n    #endif\n    if( useAlphaMap == 1. ) c.a *= texture2D( alphaMap, vUv * repeat ).a;\n    if( c.a < alphaTest ) discard;\n    gl_FragColor = c;\n\n    #include <fog_fragment>\n    #include <tonemapping_fragment>\n}",transparent:this.settings.transparent,depthWrite:!this.settings.transparent,side:t.DoubleSide,blending:this.settings.blending||t.AdditiveBlending})}},{key:"update",value:function update(){var e=this,t=0,i=0,r=0;this.systems.forEach((function(e){for(var t=0;t<e.particleNum;t++)r+=2*e.particles[t].previous.length})),r>this.maxParticles&&this.expandBuffers(r),this.systems.forEach((function(r){for(var n=r.particles,o=r.particleNum,a=e.settings.uTileCount,s=e.settings.vTileCount,l=1/a,u=1/s,c=0;c<o;c++)for(var d=n[c],h=d.uvTile%s,f=Math.floor(d.uvTile/s),p=0;p<d.previous.length;p++,t+=2){var y=d.previous[p];e.positionBuffer.setXYZ(t,y.position.x,y.position.y,y.position.z),e.positionBuffer.setXYZ(t+1,y.position.x,y.position.y,y.position.z),r.worldSpace?(e.positionBuffer.setXYZ(t,y.position.x,y.position.y,y.position.z),e.positionBuffer.setXYZ(t+1,y.position.x,y.position.y,y.position.z)):(d.parentMatrix?e.vector_.copy(y.position).applyMatrix4(d.parentMatrix):e.vector_.copy(y.position).applyMatrix4(r.emitter.matrixWorld),e.positionBuffer.setXYZ(t,e.vector_.x,e.vector_.y,e.vector_.z),e.positionBuffer.setXYZ(t+1,e.vector_.x,e.vector_.y,e.vector_.z));var v=void 0;v=p-1>=0?d.previous[p-1]:d.previous[0],r.worldSpace?(e.previousBuffer.setXYZ(t,v.position.x,v.position.y,v.position.z),e.previousBuffer.setXYZ(t+1,v.position.x,v.position.y,v.position.z)):(d.parentMatrix?e.vector_.copy(v.position).applyMatrix4(d.parentMatrix):e.vector_.copy(v.position).applyMatrix4(r.emitter.matrixWorld),e.previousBuffer.setXYZ(t,e.vector_.x,e.vector_.y,e.vector_.z),e.previousBuffer.setXYZ(t+1,e.vector_.x,e.vector_.y,e.vector_.z));var m=void 0;m=p+1<d.previous.length?d.previous[p+1]:d.previous[d.previous.length-1],r.worldSpace?(e.nextBuffer.setXYZ(t,m.position.x,m.position.y,m.position.z),e.nextBuffer.setXYZ(t+1,m.position.x,m.position.y,m.position.z)):(d.parentMatrix?e.vector_.copy(m.position).applyMatrix4(d.parentMatrix):e.vector_.copy(m.position).applyMatrix4(r.emitter.matrixWorld),e.nextBuffer.setXYZ(t,e.vector_.x,e.vector_.y,e.vector_.z),e.nextBuffer.setXYZ(t+1,e.vector_.x,e.vector_.y,e.vector_.z)),e.sideBuffer.setX(t,-1),e.sideBuffer.setX(t+1,1),e.widthBuffer.setX(t,y.size),e.widthBuffer.setX(t+1,y.size),e.uvBuffer.setXY(t,(p/d.previous.length+h)*l,(s-f-1)*u),e.uvBuffer.setXY(t+1,(p/d.previous.length+h)*l,(s-f)*u),e.colorBuffer.setXYZW(t,y.color.x,y.color.y,y.color.z,y.color.w),e.colorBuffer.setXYZW(t+1,y.color.x,y.color.y,y.color.z,y.color.w),p+1<d.previous.length&&(e.indexBuffer.setX(3*i,t),e.indexBuffer.setX(3*i+1,t+1),e.indexBuffer.setX(3*i+2,t+2),i++,e.indexBuffer.setX(3*i,t+2),e.indexBuffer.setX(3*i+1,t+1),e.indexBuffer.setX(3*i+2,t+3),i++)}})),this.positionBuffer.updateRange.count=3*t,this.positionBuffer.needsUpdate=!0,this.previousBuffer.updateRange.count=3*t,this.previousBuffer.needsUpdate=!0,this.nextBuffer.updateRange.count=3*t,this.nextBuffer.needsUpdate=!0,this.sideBuffer.updateRange.count=t,this.sideBuffer.needsUpdate=!0,this.widthBuffer.updateRange.count=t,this.widthBuffer.needsUpdate=!0,this.uvBuffer.updateRange.count=2*t,this.uvBuffer.needsUpdate=!0,this.colorBuffer.updateRange.count=4*t,this.colorBuffer.needsUpdate=!0,this.indexBuffer.updateRange.count=3*i,this.indexBuffer.needsUpdate=!0,this.geometry.setDrawRange(0,3*i)}},{key:"dispose",value:function dispose(){this.geometry.dispose()}}]),TrailBatch}(K),ae=function(t){_inherits(BatchedParticleRenderer,t);var i=_createSuper(BatchedParticleRenderer);function BatchedParticleRenderer(){var e;return _classCallCheck(this,BatchedParticleRenderer),_defineProperty(_assertThisInitialized(e=i.call(this)),"batches",[]),_defineProperty(_assertThisInitialized(e),"systemToBatchIndex",new Map),_defineProperty(_assertThisInitialized(e),"type","BatchedParticleRenderer"),e}return _createClass(BatchedParticleRenderer,[{key:"addSystem",value:function addSystem(t){for(var i,r=t.getRendererSettings(),n=0;n<this.batches.length;n++)if(BatchedParticleRenderer.equals(this.batches[n].settings,r))return this.batches[n].addSystem(t),void this.systemToBatchIndex.set(t,n);switch(r.renderMode){case e.RenderMode.Trail:i=new oe(r);break;case e.RenderMode.LocalSpace:case e.RenderMode.BillBoard:case e.RenderMode.StretchedBillBoard:i=new ne(r)}i.addSystem(t),this.batches.push(i),this.systemToBatchIndex.set(t,this.batches.length-1),this.add(i)}},{key:"deleteSystem",value:function deleteSystem(e){var t=this.systemToBatchIndex.get(e);null!=t&&(this.batches[t].removeSystem(e),this.systemToBatchIndex.delete(e))}},{key:"updateSystem",value:function updateSystem(e){this.deleteSystem(e),this.addSystem(e)}},{key:"update",value:function update(e){this.systemToBatchIndex.forEach((function(t,i){i.update(e)}));for(var t=0;t<this.batches.length;t++)this.batches[t].update()}}],[{key:"equals",value:function equals(e,t){return e.texture===t.texture&&e.blending===t.blending&&e.renderMode===t.renderMode&&e.uTileCount===t.uTileCount&&e.vTileCount===t.vTileCount&&e.instancingGeometry===t.instancingGeometry&&e.transparent===t.transparent&&e.renderOrder===t.renderOrder}}]),BatchedParticleRenderer}(t.Object3D),se={Int8Array:Int8Array,Uint8Array:Uint8Array,Uint8ClampedArray:Uint8ClampedArray,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array},le={BoxGeometry:t.BoxGeometry,CircleGeometry:t.CircleGeometry,ConeGeometry:t.ConeGeometry,CylinderGeometry:t.CylinderGeometry,DodecahedronGeometry:t.DodecahedronGeometry,EdgesGeometry:t.EdgesGeometry,ExtrudeGeometry:t.ExtrudeGeometry,IcosahedronGeometry:t.IcosahedronGeometry,LatheGeometry:t.LatheGeometry,OctahedronGeometry:t.OctahedronGeometry,PlaneGeometry:t.PlaneGeometry,PolyhedronGeometry:t.PolyhedronGeometry,RingGeometry:t.RingGeometry,ShapeGeometry:t.ShapeGeometry,SphereGeometry:t.SphereGeometry,TetrahedronGeometry:t.TetrahedronGeometry,TorusGeometry:t.TorusGeometry,TorusKnotGeometry:t.TorusKnotGeometry,TubeGeometry:t.TubeGeometry,WireframeGeometry:t.WireframeGeometry},ue=function(){function QuarksLoader(e){_classCallCheck(this,QuarksLoader),_defineProperty(this,"manager",void 0),_defineProperty(this,"crossOrigin","anonymous"),_defineProperty(this,"path",void 0),_defineProperty(this,"resourcePath",void 0),this.manager=void 0!==e?e:t.DefaultLoadingManager,this.resourcePath=""}return _createClass(QuarksLoader,[{key:"setPath",value:function setPath(e){return this.path=e,this}},{key:"setResourcePath",value:function setResourcePath(e){return this.resourcePath=e,this}},{key:"setCrossOrigin",value:function setCrossOrigin(e){return this.crossOrigin=e,this}},{key:"load",value:function load(e,i,r,n,o){var a=this,s=void 0===this.path?t.LoaderUtils.extractUrlBase(e):this.path;this.resourcePath=this.resourcePath||s;var l=new t.FileLoader(a.manager);this.path&&l.setPath(this.path),l.load(e,(function(t){var n=null;try{n=JSON.parse(t)}catch(t){return void 0!==o&&o(t),void console.error("THREE:ObjectLoader: Can't parse "+e+".",t.message)}var s=n.metadata;void 0!==s&&void 0!==s.type&&"geometry"!==s.type.toLowerCase()?a.parse(n,r,i):console.error("THREE.ObjectLoader: Can't load "+e)}),n,o)}},{key:"loadImage",value:function loadImage(e,t){var i=this;return i.manager.itemStart(t),e.load(t,(function(){i.manager.itemEnd(t)}),void 0,(function(){i.manager.itemError(t),i.manager.itemEnd(t)}))}},{key:"deserializeImage",value:function deserializeImage(e,t){if("string"==typeof t){var i=t,r=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(i)?i:this.resourcePath+i;return this.loadImage(e,r)}return t.data?{data:(n=t.type,o=t.data,new se[n](o)),width:t.width,height:t.height}:null;var n,o}},{key:"parseImages",value:function parseImages(e,i){var r,n={};if(void 0!==e&&e.length>0){var o=new t.LoadingManager(i);(r=new t.ImageLoader(o)).setCrossOrigin(this.crossOrigin);for(var a=0,s=e.length;a<s;a++){var l=e[a],u=l.url;if(Array.isArray(u)){for(var c=[],d=0,h=u.length;d<h;d++){var f=u[d],p=this.deserializeImage(r,f);null!==p&&(p instanceof HTMLImageElement?c.push(p):c.push(new t.DataTexture(p.data,p.width,p.height)))}n[l.uuid]=new t.Source(c)}else{var y=this.deserializeImage(r,l.url);n[l.uuid]=new t.Source(y)}}}return n}},{key:"parseShapes",value:function parseShapes(e){var i={};if(void 0!==e)for(var r=0,n=e.length;r<n;r++){var o=(new t.Shape).fromJSON(e[r]);i[o.uuid]=o}return i}},{key:"parseGeometries",value:function parseGeometries(e,i){var r={};if(void 0!==e)for(var n=new t.BufferGeometryLoader,o=0,a=e.length;o<a;o++){var s=void 0,l=e[o];switch(l.type){case"BufferGeometry":case"InstancedBufferGeometry":s=n.parse(l);break;case"Geometry":console.error("THREE.ObjectLoader: The legacy Geometry type is no longer supported.");break;default:if(!(l.type in le)||!le[l.type].fromJSON){console.warn('THREE.ObjectLoader: Unsupported geometry type "'.concat(l.type,'"'));continue}s=le[l.type].fromJSON(l,i)}s.uuid=l.uuid,void 0!==l.name&&(s.name=l.name),s.isBufferGeometry&&void 0!==l.userData&&(s.userData=l.userData),r[l.uuid]=s}return r}},{key:"parseTextures",value:function parseTextures(e,i){function parseConstant(e,t){return"number"==typeof e?e:(console.warn("THREE.ObjectLoader.parseTexture: Constant should be in numeric form.",e),t[e])}var r={};if(void 0!==e)for(var n=0,o=e.length;n<o;n++){var a=e[n];void 0===a.image&&console.warn('THREE.ObjectLoader: No "image" specified for',a.uuid),void 0===i[a.image]&&console.warn("THREE.ObjectLoader: Undefined image",a.image);var s=i[a.image],l=s.data,u=void 0;Array.isArray(l)?(u=new t.CubeTexture,6===l.length&&(u.needsUpdate=!0)):(u=l&&l.data?new t.DataTexture:new t.Texture,l&&(u.needsUpdate=!0)),u.source=s,u.uuid=a.uuid,void 0!==a.name&&(u.name=a.name),void 0!==a.mapping&&(u.mapping=parseConstant(a.mapping,ce)),void 0!==a.offset&&u.offset.fromArray(a.offset),void 0!==a.repeat&&u.repeat.fromArray(a.repeat),void 0!==a.center&&u.center.fromArray(a.center),void 0!==a.rotation&&(u.rotation=a.rotation),void 0!==a.wrap&&(u.wrapS=parseConstant(a.wrap[0],de),u.wrapT=parseConstant(a.wrap[1],de)),void 0!==a.format&&(u.format=a.format),void 0!==a.type&&(u.type=a.type),void 0!==a.encoding&&(u.encoding=a.encoding),void 0!==a.minFilter&&(u.minFilter=parseConstant(a.minFilter,he)),void 0!==a.magFilter&&(u.magFilter=parseConstant(a.magFilter,he)),void 0!==a.anisotropy&&(u.anisotropy=a.anisotropy),void 0!==a.flipY&&(u.flipY=a.flipY),void 0!==a.premultiplyAlpha&&(u.premultiplyAlpha=a.premultiplyAlpha),void 0!==a.unpackAlignment&&(u.unpackAlignment=a.unpackAlignment),void 0!==a.userData&&(u.userData=a.userData),r[a.uuid]=u}return r}},{key:"parseObject",value:function parseObject(e,i,r,n){var o;switch(e.type){case"ParticleEmitter":o=ie.fromJSON(e.ps,i,r,n).emitter;break;case"Group":o=new t.Group;break;default:o=new t.Object3D}if(o.uuid=e.uuid,void 0!==e.name&&(o.name=e.name),void 0!==e.matrix?(o.matrix.fromArray(e.matrix),void 0!==e.matrixAutoUpdate&&(o.matrixAutoUpdate=e.matrixAutoUpdate),o.matrixAutoUpdate&&o.matrix.decompose(o.position,o.quaternion,o.scale)):(void 0!==e.position&&o.position.fromArray(e.position),void 0!==e.rotation&&o.rotation.fromArray(e.rotation),void 0!==e.quaternion&&o.quaternion.fromArray(e.quaternion),void 0!==e.scale&&o.scale.fromArray(e.scale)),void 0!==e.castShadow&&(o.castShadow=e.castShadow),void 0!==e.receiveShadow&&(o.receiveShadow=e.receiveShadow),void 0!==e.visible&&(o.visible=e.visible),void 0!==e.frustumCulled&&(o.frustumCulled=e.frustumCulled),void 0!==e.renderOrder&&(o.renderOrder=e.renderOrder),void 0!==e.userData&&(o.userData=e.userData),void 0!==e.layers&&(o.layers.mask=e.layers),void 0!==e.children)for(var a=e.children,s=0;s<a.length;s++)o.add(this.parseObject(a[s],i,r,n));return o}},{key:"parse",value:function parse(e,t,i){var r=this.parseImages(e.images,(function(){void 0!==t&&t(l)})),n=this.parseTextures(e.textures,r),o=this.parseShapes(e.shapes),a={images:r,textures:n,shapes:o,geometries:this.parseGeometries(e.geometries,o)},s={},l=this.parseObject(e.object,a,s,i);return l.traverse((function(e){s[e.uuid]&&(s[e.uuid].subParticleSystem=e)})),void 0!==e.images&&0!==e.images.length||void 0!==t&&t(l),l}}]),QuarksLoader}(),ce={UVMapping:t.UVMapping,CubeReflectionMapping:t.CubeReflectionMapping,CubeRefractionMapping:t.CubeRefractionMapping,EquirectangularReflectionMapping:t.EquirectangularReflectionMapping,EquirectangularRefractionMapping:t.EquirectangularRefractionMapping,CubeUVReflectionMapping:t.CubeUVReflectionMapping},de={RepeatWrapping:t.RepeatWrapping,ClampToEdgeWrapping:t.ClampToEdgeWrapping,MirroredRepeatWrapping:t.MirroredRepeatWrapping},he={NearestFilter:t.NearestFilter,NearestMipmapNearestFilter:t.NearestMipmapNearestFilter,NearestMipmapLinearFilter:t.NearestMipmapLinearFilter,LinearFilter:t.LinearFilter,LinearMipmapNearestFilter:t.LinearMipmapNearestFilter,LinearMipmapLinearFilter:t.LinearMipmapLinearFilter};e.ApplyForce=C,e.AxisAngleGenerator=h,e.BatchedParticleRenderer=ae,e.BehaviorFromJSON=BehaviorFromJSON,e.BehaviorTypes=X,e.Bezier=u,e.ChangeEmitDirection=k,e.ColorGeneratorFromJSON=ColorGeneratorFromJSON,e.ColorOverLife=S,e.ColorRange=v,e.ConeEmitter=Q,e.ConstantColor=m,e.ConstantValue=a,e.DonutEmitter=W,e.EmitSubParticleSystem=z,e.EmitterFromJSON=EmitterFromJSON,e.EmitterShapes=H,e.FrameOverLife=w,e.GeneratorFromJSON=GeneratorFromJSON,e.Gradient=g,e.GravityForce=b,e.IntervalValue=s,e.MeshSurfaceEmitter=Z,e.OrbitOverLife=P,e.ParticleEmitter=i,e.ParticleSystem=ie,e.ParticleSystemBatch=K,e.PiecewiseBezier=c,e.PiecewiseFunction=l,e.PointEmitter=q,e.QuarksLoader=ue,e.RandomColor=y,e.RandomQuatGenerator=d,e.RecordState=n,e.Rotation3DOverLife=D,e.RotationGeneratorFromJSON=RotationGeneratorFromJSON,e.RotationOverLife=_,e.SizeOverLife=O,e.SpeedOverLife=x,e.SphereEmitter=Y,e.SpriteBatch=ne,e.SpriteParticle=r,e.TrailBatch=oe,e.TrailParticle=o,e.TurbulenceField=I,e.ValueGeneratorFromJSON=ValueGeneratorFromJSON,e.WidthOverLength=B,Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).THREE=e.THREE||{},e.THREE.QUARKS={}),e.THREE)}));
